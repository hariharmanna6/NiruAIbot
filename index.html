<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Universal AI Chat</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    }
  </script>

  <!-- Marked.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    html, body {
      height: 100%;
    }
    .typing-caret::after {
      content: "‚ñã";
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%,50%,100% { opacity: 1 }
      25%,75% { opacity: 0 }
    }
  </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex">

<div id="loading" class="fixed inset-0 flex items-center justify-center bg-white dark:bg-gray-900 z-50">
  <span class="text-lg font-medium">Loading App...</span>
</div>

<!-- Sidebar -->
<aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-72 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform z-40">
  <div class="p-4 flex items-center justify-between border-b dark:border-gray-700">
    <span class="font-semibold">Chats</span>
    <button id="newChatBtn" class="text-sm px-2 py-1 bg-blue-600 text-white rounded">New</button>
  </div>
  <div id="chatList" class="flex-1 overflow-y-auto"></div>
</aside>

<!-- Main -->
<main class="flex-1 flex flex-col min-h-screen md:ml-72">

  <!-- Header -->
  <header class="h-14 flex items-center justify-between px-4 border-b dark:border-gray-700 bg-white dark:bg-gray-800">
    <div class="flex items-center gap-2">
      <button id="menuBtn" class="md:hidden text-xl">‚ò∞</button>
      <span id="chatTitle" class="font-medium truncate">New Chat</span>
    </div>
    <div class="flex gap-3">
      <button id="darkToggle">üåô</button>
      <button id="settingsBtn">‚öôÔ∏è</button>
    </div>
  </header>

  <!-- Messages -->
  <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

  <!-- Input -->
  <div class="sticky bottom-0 bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-3">
    <form id="chatForm" class="flex gap-2">
      <textarea id="userInput" rows="1" placeholder="Message..."
        class="flex-1 resize-none rounded border dark:border-gray-600 p-2 bg-white dark:bg-gray-700"></textarea>
      <button class="px-4 bg-blue-600 text-white rounded">Send</button>
    </form>
  </div>
</main>

<!-- Settings Modal -->
<div id="settingsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white dark:bg-gray-800 w-full max-w-md p-4 rounded space-y-3">
    <h2 class="font-semibold text-lg">Settings</h2>

    <div>
      <label class="text-sm">OpenRouter API Key</label>
      <input id="apiKeyInput" type="password" class="w-full p-2 rounded border dark:border-gray-600 bg-white dark:bg-gray-700">
    </div>

    <div>
      <label class="text-sm">Model</label>
      <select id="modelSelect" class="w-full p-2 rounded border dark:border-gray-600 bg-white dark:bg-gray-700"></select>
    </div>

    <div>
      <label class="text-sm">System Prompt</label>
      <textarea id="systemPromptInput" rows="3" class="w-full p-2 rounded border dark:border-gray-600 bg-white dark:bg-gray-700"></textarea>
    </div>

    <div class="flex justify-end gap-2">
      <button id="closeSettings" class="px-3 py-1 border rounded">Close</button>
      <button id="saveSettings" class="px-3 py-1 bg-blue-600 text-white rounded">Save</button>
    </div>
  </div>
</div>

<script>
/* ------------------ STATE ------------------ */
const MODELS = [
  "arcee-ai/trinity-large-preview:free",
  "tngtech/deepseek-r1t2-chimera:free",
  "z-ai/glm-4.5-air:free",
  "stepfun/step-3.5-flash:free",
  "tngtech/deepseek-r1t-chimera:free",
  "nvidia/nemotron-3-nano-30b-a3b:free",
  "deepseek/deepseek-r1-0528:free",
  "tngtech/tng-r1t-chimera:free",
  "openai/gpt-oss-120b:free",
  "qwen/qwen3-coder:free",
  "upstage/solar-pro-3:free",
  "meta-llama/llama-3.3-70b-instruct:free",
  "arcee-ai/trinity-mini:free",
  "openai/gpt-oss-20b:free",
  "qwen/qwen3-next-80b-a3b-instruct:free",
  "nvidia/nemotron-nano-12b-v2-vl:free",
  "nvidia/nemotron-nano-9b-v2:free",
  "google/gemma-3-27b-it:free",
  "cognitivecomputations/dolphin-mistral-24b-venice-edition:free",
  "liquid/lfm-2.5-1.2b-instruct:free",
  "liquid/lfm-2.5-1.2b-thinking:free",
  "mistralai/mistral-small-3.1-24b-instruct:free",
  "nousresearch/hermes-3-llama-3.1-405b:free",
  "google/gemma-3n-e2b-it:free",
  "qwen/qwen3-4b:free",
  "google/gemma-3-12b-it:free",
  "meta-llama/llama-3.2-3b-instruct:free",
  "google/gemma-3n-e4b-it:free",
  "openrouter/free"
];

let chats = JSON.parse(localStorage.getItem("chats") || "[]");
let activeChatId = localStorage.getItem("activeChatId");
let settings = JSON.parse(localStorage.getItem("settings") || "{}");

/* ------------------ INIT ------------------ */
document.addEventListener("DOMContentLoaded", () => {
  initModels();
  loadTheme();
  if (!chats.length) createChat();
  renderChats();
  openChat(activeChatId || chats[0].id);
  document.getElementById("loading").style.display = "none";
});

/* ------------------ UI HELPERS ------------------ */
function initModels() {
  const sel = document.getElementById("modelSelect");
  MODELS.forEach(m => {
    const o = document.createElement("option");
    o.value = o.textContent = m;
    sel.appendChild(o);
  });
  sel.value = settings.model || MODELS[0];
}

function loadTheme() {
  if (localStorage.getItem("dark") === "true") {
    document.documentElement.classList.add("dark");
  }
}

/* ------------------ CHAT LOGIC ------------------ */
function createChat() {
  const id = Date.now().toString();
  chats.push({ id, title: "New Chat", messages: [], system: "" });
  activeChatId = id;
  saveChats();
}

function openChat(id) {
  activeChatId = id;
  localStorage.setItem("activeChatId", id);
  const chat = chats.find(c => c.id === id);
  document.getElementById("chatTitle").textContent = chat.title;
  document.getElementById("systemPromptInput").value = chat.system || "";
  renderMessages(chat.messages);
}

function renderChats() {
  const list = document.getElementById("chatList");
  list.innerHTML = "";
  chats.forEach(c => {
    const div = document.createElement("div");
    div.className = "px-4 py-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700";
    div.textContent = c.title;
    div.onclick = () => openChat(c.id);
    list.appendChild(div);
  });
}

function renderMessages(msgs) {
  const box = document.getElementById("messages");
  box.innerHTML = "";
  msgs.forEach(m => addMessage(m.role, m.content));
  box.scrollTop = box.scrollHeight;
}

function addMessage(role, content, streaming=false) {
  const wrap = document.createElement("div");
  wrap.className = `flex ${role === "user" ? "justify-end" : "justify-start"}`;
  const bubble = document.createElement("div");
  bubble.className = `max-w-[80%] p-3 rounded ${
    role === "user"
      ? "bg-blue-600 text-white"
      : "bg-gray-200 dark:bg-gray-700"
  }`;
  bubble.innerHTML = streaming ? content : marked.parse(content);
  wrap.appendChild(bubble);
  document.getElementById("messages").appendChild(wrap);
  return bubble;
}

/* ------------------ SEND MESSAGE ------------------ */
document.getElementById("chatForm").onsubmit = async e => {
  e.preventDefault();
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (!text) return;
  input.value = "";

  const chat = chats.find(c => c.id === activeChatId);
  chat.messages.push({ role: "user", content: text });
  addMessage("user", text);

  const aiBubble = addMessage("assistant", "", true);
  let full = "";

  try {
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + settings.apiKey
      },
      body: JSON.stringify({
        model: settings.model,
        stream: true,
        messages: [
          ...(chat.system ? [{ role: "system", content: chat.system }] : []),
          ...chat.messages
        ]
      })
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder();

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value);
      chunk.split("\n").forEach(line => {
        if (line.startsWith("data: ")) {
          const data = line.replace("data: ", "");
          if (data === "[DONE]") return;
          try {
            const json = JSON.parse(data);
            const token = json.choices?.[0]?.delta?.content;
            if (token) {
              full += token;
              aiBubble.innerHTML = marked.parse(full) + '<span class="typing-caret"></span>';
            }
          } catch {}
        }
      });
    }
  } catch (err) {
    aiBubble.textContent = "Error fetching response.";
  }

  aiBubble.innerHTML = marked.parse(full);
  chat.messages.push({ role: "assistant", content: full });
  saveChats();
};

/* ------------------ SETTINGS ------------------ */
document.getElementById("settingsBtn").onclick = () =>
  document.getElementById("settingsModal").classList.remove("hidden");

document.getElementById("closeSettings").onclick = () =>
  document.getElementById("settingsModal").classList.add("hidden");

document.getElementById("saveSettings").onclick = () => {
  settings.apiKey = document.getElementById("apiKeyInput").value;
  settings.model = document.getElementById("modelSelect").value;
  const chat = chats.find(c => c.id === activeChatId);
  chat.system = document.getElementById("systemPromptInput").value;
  localStorage.setItem("settings", JSON.stringify(settings));
  saveChats();
  document.getElementById("settingsModal").classList.add("hidden");
};

/* ------------------ MISC ------------------ */
document.getElementById("darkToggle").onclick = () => {
  document.documentElement.classList.toggle("dark");
  localStorage.setItem("dark", document.documentElement.classList.contains("dark"));
};

document.getElementById("menuBtn").onclick = () =>
  document.getElementById("sidebar").classList.toggle("-translate-x-full");

document.getElementById("newChatBtn").onclick = () => {
  createChat();
  renderChats();
  openChat(activeChatId);
};

function saveChats() {
  localStorage.setItem("chats", JSON.stringify(chats));
}
</script>

</body>
</html>
