<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TradeEdge</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:ital,wght@0,300;0,400;0,500&family=Fraunces:ital,wght@0,300;0,600;1,300&display=swap" rel="stylesheet">
<style>
/* ─── RESET ─── */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}

/* ─── VARIABLES ─── */
:root{
  --bg:#0a0a0f;
  --surface:#12121a;
  --surface2:#1a1a26;
  --border:rgba(255,255,255,0.07);
  --accent:#00e5a0;
  --accent2:#ff4d6d;
  --accent3:#6c63ff;
  --text:#f0f0f8;
  --muted:#6b6b8a;
  --win:#00e5a0;
  --loss:#ff4d6d;
  --tie:#f4a261;
  --buy:#6c63ff;
  --sell:#f4a261;
  --radius:16px;
  --shadow:0 8px 40px rgba(0,0,0,0.5);
}
body.light{
  --bg:#f5f5fa;--surface:#ffffff;--surface2:#f0f0f8;
  --border:rgba(0,0,0,0.08);--text:#1a1a2e;--muted:#8888aa;
}
/* ─── THEME: MIDNIGHT BLUE ─── */
body.theme-midnight{
  --bg:#04091a;--surface:#0a1628;--surface2:#0f1f3a;
  --border:rgba(77,150,255,0.12);
  --accent:#4d96ff;--accent2:#ff6b9d;--accent3:#a78bfa;
  --text:#d8e8ff;--muted:#4a6080;
  --win:#4d96ff;--loss:#ff6b9d;--tie:#fbbf24;
  --buy:#a78bfa;--sell:#fbbf24;
}
body.theme-midnight header{background:rgba(4,9,26,.9)}
body.theme-midnight .bg-glow::before{background:radial-gradient(ellipse,rgba(77,150,255,.12) 0%,transparent 70%)}
body.theme-midnight .bg-glow::after{background:radial-gradient(ellipse,rgba(167,139,250,.08) 0%,transparent 70%)}
body.theme-midnight nav button.active{background:var(--accent);color:#04091a}
body.theme-midnight .prog-bar{background:linear-gradient(90deg,var(--accent),var(--accent3))}
body.theme-midnight .acct-tab.active{color:#04091a}

/* ─── THEME: WARM AMBER ─── */
body.theme-amber{
  --bg:#110d05;--surface:#1c1508;--surface2:#251c0b;
  --border:rgba(245,158,11,0.12);
  --accent:#f59e0b;--accent2:#ef4444;--accent3:#34d399;
  --text:#fef3c7;--muted:#6b5a30;
  --win:#34d399;--loss:#ef4444;--tie:#f59e0b;
  --buy:#34d399;--sell:#f59e0b;
}
body.theme-amber header{background:rgba(17,13,5,.9)}
body.theme-amber .bg-glow::before{background:radial-gradient(ellipse,rgba(245,158,11,.10) 0%,transparent 70%)}
body.theme-amber .bg-glow::after{background:radial-gradient(ellipse,rgba(52,211,153,.07) 0%,transparent 70%)}
body.theme-amber nav button.active{background:var(--accent);color:#110d05}
body.theme-amber .set-btn,.theme-amber .btn-primary{color:#110d05}
body.theme-amber .acct-tab.active{color:#110d05}

/* ─── THEME SWITCHER DOTS ─── */
.theme-strip{display:flex;align-items:center;gap:5px;flex-shrink:0}
.theme-dot{
  width:20px;height:20px;border-radius:50%;cursor:pointer;
  border:2px solid transparent;transition:all .25s;
  flex-shrink:0;position:relative;
}
.theme-dot:hover{transform:scale(1.2)}
.theme-dot.active{border-color:var(--text);box-shadow:0 0 0 2px var(--accent)}
.td-dark{background:conic-gradient(#0a0a0f 0%,#1a1a26 100%)}
.td-light{background:conic-gradient(#f0f0f8 0%,#ffffff 100%)}
.td-midnight{background:conic-gradient(#04091a 0%,#0f1f3a 50%,#4d96ff 100%)}
.td-amber{background:conic-gradient(#110d05 0%,#251c0b 50%,#f59e0b 100%)}

/* ─── MULTI-ACCOUNT SWITCHER ─── */
.acct-switcher{
  display:flex;align-items:center;gap:3px;
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;padding:3px;flex-shrink:0;
}
.acct-tab{
  font-family:'Syne',sans-serif;font-size:.68rem;font-weight:700;
  background:transparent;border:none;color:var(--muted);
  padding:4px 10px;border-radius:5px;cursor:pointer;
  transition:all .2s;white-space:nowrap;
}
.acct-tab.active{background:var(--accent);color:#0a0a0f}
.acct-label{
  font-family:'Syne',sans-serif;font-size:.58rem;font-weight:700;
  letter-spacing:1px;text-transform:uppercase;
  color:var(--muted);padding:0 4px;
}

/* ─── TRADE TIME COLUMNS ─── */
.time-badge{
  display:inline-block;padding:2px 6px;border-radius:5px;
  font-family:'DM Mono',monospace;font-size:.67rem;
  background:var(--surface2);border:1px solid var(--border);
  color:var(--muted);white-space:nowrap;
}
.time-badge.has-time{color:var(--text);border-color:rgba(108,99,255,.3)}

/* ─── HEATMAP CALENDAR ─── */
.heatmap-section{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:22px 24px;margin-top:16px;
}
.heatmap-header{
  display:flex;align-items:center;justify-content:space-between;
  flex-wrap:wrap;gap:10px;margin-bottom:16px;
}
.heatmap-title-text{font-family:'Syne',sans-serif;font-size:.9rem;font-weight:800}
.heatmap-controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.heatmap-controls select{
  padding:5px 9px;background:var(--surface2);border:1px solid var(--border);
  color:var(--text);border-radius:8px;
  font-family:'DM Mono',monospace;font-size:.76rem;cursor:pointer;transition:border .2s;
}
.heatmap-controls select:focus{outline:none;border-color:var(--accent)}
.hm-legend{display:flex;align-items:center;gap:5px;font-size:.66rem;color:var(--muted)}
.hm-legend-row{display:flex;gap:2px}
.hm-swatch{width:11px;height:11px;border-radius:2px}
.heatmap-grid-wrap{overflow-x:auto;padding-bottom:4px}
.heatmap-month-row{
  display:flex;gap:3px;margin-left:26px;margin-bottom:4px;
}
.hm-month-lbl{
  font-family:'Syne',sans-serif;font-size:.6rem;color:var(--muted);
  width:13px;text-align:left;overflow:visible;white-space:nowrap;
}
.heatmap-body{display:flex;gap:2px}
.hm-day-labels{
  display:flex;flex-direction:column;gap:2px;margin-right:4px;width:20px;
}
.hm-day-lbl{
  height:13px;font-family:'Syne',sans-serif;font-size:.58rem;
  color:var(--muted);line-height:13px;text-align:right;padding-right:3px;
}
.heatmap-weeks{display:flex;gap:2px}
.hm-week{display:flex;flex-direction:column;gap:2px}
.hm-cell{
  width:13px;height:13px;border-radius:2px;
  cursor:default;transition:transform .1s;
  background:var(--surface2);
}
.hm-cell:hover{transform:scale(1.5);z-index:10;position:relative}
/* Win-rate green scale */
.hm-g1{background:rgba(0,229,160,.20)}
.hm-g2{background:rgba(0,229,160,.45)}
.hm-g3{background:rgba(0,229,160,.70)}
.hm-g4{background:rgba(0,229,160,1.00);box-shadow:0 0 4px rgba(0,229,160,.5)}
/* Loss red scale */
.hm-r1{background:rgba(255,77,109,.20)}
.hm-r2{background:rgba(255,77,109,.45)}
.hm-r3{background:rgba(255,77,109,.70)}
.hm-r4{background:rgba(255,77,109,1.00);box-shadow:0 0 4px rgba(255,77,109,.5)}
/* P&L: use green/red, trade count: purple scale */
.hm-p1{background:rgba(108,99,255,.20)}
.hm-p2{background:rgba(108,99,255,.45)}
.hm-p3{background:rgba(108,99,255,.70)}
.hm-p4{background:rgba(108,99,255,1.00)}
.hm-tooltip-box{
  position:fixed;z-index:9999;pointer-events:none;
  background:var(--surface);border:1px solid var(--border);
  border-radius:9px;padding:8px 13px;
  font-size:.72rem;color:var(--text);
  box-shadow:0 8px 32px rgba(0,0,0,.5);
  white-space:nowrap;display:none;
}

/* ─── DOW + HOUR ANALYSIS ─── */
.analytics-extra-grid{
  display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:15px;
}
@media(max-width:900px){.analytics-extra-grid{grid-template-columns:1fr}}
.analysis-panel{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:20px 22px;
}
.analysis-panel-title{
  font-family:'Syne',sans-serif;font-size:.82rem;font-weight:800;
  margin-bottom:4px;
}
.analysis-panel-sub{font-size:.68rem;color:var(--muted);margin-bottom:14px}
.analysis-chart-wrap{position:relative;height:200px}
.no-time-note{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  height:200px;color:var(--muted);text-align:center;font-size:.75rem;line-height:1.8;
}
.no-time-note .emo{font-size:1.8rem;margin-bottom:8px}

/* ─── PRINT STYLES ─── */
@media print{
  /* hide everything interactive */
  .bg-glow,header nav,.theme-strip,button.theme-btn,
  .toast-stack,.export-modal-overlay,.modal-overlay,
  .import-card .drop-zone,.import-card .import-filename,
  .import-card .import-processing,.import-card .impStats,
  .import-card .import-actions,.import-card .btn-dl-xlsx,
  .import-card .impMetaRow,.import-card .multidateSummary,
  .panel-actions,.del-btn,.exp-btn,.left-panel .export-row,
  .backup-section,.storage-actions-bar,.acct-switcher,
  .balance-hide-btn,.balance-input-wrap,
  .goal-row,.set-btn,.goal-inp,
  .period-tabs,.pgi-set,.pgi-inp,
  .heatmap-controls,.pairs-filter-bar,
  .summary-filter-bar,.filter-bar button,
  .storage-intro .storage-legend{display:none!important}

  *{-webkit-print-color-adjust:exact;print-color-adjust:exact}
  @page{margin:15mm;size:A4 portrait}
  html,body{background:#fff!important;color:#111!important;font-size:11pt}
  body::before,body::after,.bg-glow::before,.bg-glow::after{display:none!important}
  header{
    position:static!important;background:#fff!important;
    border-bottom:2px solid #ccc!important;backdrop-filter:none!important;
    padding:8px 16px!important;height:auto!important;
    display:flex!important;align-items:center!important;
    box-shadow:none!important;
  }
  .logo{font-size:1.1rem!important}
  .logo em{color:#007a52!important}
  .balance-display{color:#007a52!important}
  .view{display:none!important}
  .view.active{display:block!important}
  .trades-layout{display:block!important}
  .left-panel{
    position:static!important;max-height:none!important;
    overflow:visible!important;border-right:none!important;
    border-bottom:1px solid #ddd!important;
    padding-bottom:16px!important;margin-bottom:16px!important;
  }
  .right-panel{padding:0!important}
  .chart-card,.goal-card,.stat-card,.pnl-stat-card,
  .kpi-card,.chart-panel,.sum-section,.analysis-panel,
  .heatmap-section,.period-goals-section,.file-info-box,
  .storage-table-wrap,.pair-card,.backup-section{
    break-inside:avoid;
    border:1px solid #ddd!important;
    border-radius:8px!important;
    background:#fafafa!important;
    box-shadow:none!important;
  }
  .table-scroll{overflow:visible!important;border:1px solid #ddd!important}
  table{min-width:0!important;font-size:9pt!important}
  thead tr{background:#f0f0f0!important}
  th,td{color:#111!important;border-color:#ddd!important}
  .dir-buy,.dir-sell{background:#eee!important;color:#333!important}
  .s-win{background:#d4f4e8!important;color:#007a52!important}
  .s-loss{background:#fde8ec!important;color:#c0283a!important}
  .s-tie{background:#fef4e0!important;color:#b37000!important}
  .pnl-pos{color:#007a52!important}
  .pnl-neg{color:#c0283a!important}
  .stat-card .v,.kpi-val,.sum-kpi-val,.sov-val{color:#111!important}
  .c-green{color:#007a52!important}
  .c-red{color:#c0283a!important}
  .hm-cell{border:1px solid #ddd!important}
  canvas{max-width:100%!important;break-inside:avoid}
  .import-card-head{border-bottom:1px solid #ddd!important}
}

/* ─── BASE ─── */
body{
  background:var(--bg);color:var(--text);
  font-family:'DM Mono',monospace;
  min-height:100vh;overflow-x:hidden;
  transition:background .3s,color .3s;
  isolation:isolate;
}
.bg-glow{position:fixed;inset:0;pointer-events:none;z-index:0}
.bg-glow::before{
  content:'';position:absolute;
  width:700px;height:500px;
  background:radial-gradient(ellipse,rgba(108,99,255,.13) 0%,transparent 70%);
  top:-120px;left:-180px;
}
.bg-glow::after{
  content:'';position:absolute;
  width:600px;height:500px;
  background:radial-gradient(ellipse,rgba(0,229,160,.09) 0%,transparent 70%);
  bottom:-100px;right:-150px;
}

/* ─── HEADER ─── */
header{
  position:sticky;top:0;z-index:200;
  height:64px;padding:0 28px;
  display:flex;align-items:center;justify-content:space-between;gap:16px;
  background:rgba(10,10,15,.88);
  backdrop-filter:blur(18px);
  border-bottom:1px solid var(--border);
}
body.light header{background:rgba(245,245,250,.9)}
.logo{
  font-family:'Syne',sans-serif;font-size:1.35rem;font-weight:800;
  letter-spacing:-.5px;white-space:nowrap;
}
.logo em{color:var(--accent);font-style:normal}
nav{display:flex;gap:4px;background:var(--surface2);border-radius:12px;padding:4px}
nav button{
  font-family:'Syne',sans-serif;font-size:.8rem;font-weight:600;
  background:transparent;border:none;color:var(--muted);
  padding:7px 16px;border-radius:8px;cursor:pointer;
  transition:all .2s;white-space:nowrap;
}
nav button.active{background:var(--accent);color:#0a0a0f}
.theme-btn{
  width:36px;height:36px;border-radius:10px;
  background:var(--surface2);border:1px solid var(--border);
  color:var(--text);font-size:1rem;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .2s;flex-shrink:0;
}
.theme-btn:hover{border-color:var(--accent)}

/* ─── VIEWS ─── */
.view{display:none;position:relative;z-index:2}
.view.active{display:block;position:relative;z-index:2}

/* ─── TRADES LAYOUT ─── */
.trades-layout{
  display:grid;
  grid-template-columns:340px 1fr;
  min-height:calc(100vh - 64px);
  position:relative;
  z-index:2;
}
@media(max-width:900px){
  .trades-layout{grid-template-columns:1fr}
  header{padding:0 12px;gap:8px;height:auto;min-height:64px;flex-wrap:wrap;padding-top:8px;padding-bottom:8px}
  nav{flex-wrap:wrap;gap:3px}
  nav button{padding:5px 9px;font-size:.68rem}
  .balance-wrap{padding:4px 9px}
  .balance-display{font-size:.9rem;min-width:60px}
  .balance-label{display:none}
}
@media(max-width:600px){
  header{padding:6px 10px;gap:6px}
  nav button{padding:4px 7px;font-size:.62rem}
  .balance-wrap{padding:3px 7px}
  .balance-display{font-size:.82rem;min-width:52px}
  #balanceInput{width:80px;font-size:.82rem}
}

/* ─── LEFT PANEL ─── */
.left-panel{
  border-right:1px solid var(--border);
  padding:22px 18px;
  display:flex;flex-direction:column;gap:18px;
  overflow-y:auto;
  max-height:calc(100vh - 64px);
  position:sticky;top:64px;
}
@media(max-width:900px){
  .left-panel{
    position:static;max-height:none;
    border-right:none;border-bottom:1px solid var(--border);
  }
}
.section-label{
  font-family:'Syne',sans-serif;font-size:.66rem;font-weight:700;
  letter-spacing:2px;text-transform:uppercase;color:var(--muted);
  margin-bottom:6px;
}

/* Date input */
.date-inp{
  width:100%;padding:10px 14px;
  background:var(--surface2);border:1px solid var(--border);
  color:var(--text);border-radius:10px;
  font-family:'DM Mono',monospace;font-size:.88rem;
  cursor:pointer;color-scheme:dark;transition:border .2s;
}
body.light .date-inp{color-scheme:light}
.date-inp:focus{outline:none;border-color:var(--accent)}

/* Chart card */
.chart-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:18px;text-align:center;
}
.chart-wrap{position:relative;width:156px;height:156px;margin:0 auto 12px}
.chart-center{
  position:absolute;inset:0;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  pointer-events:none;
}
.chart-center .rate{
  font-family:'Fraunces',serif;font-size:1.9rem;font-weight:600;color:var(--accent);line-height:1;
}
.chart-center .lbl{font-size:.62rem;color:var(--muted);letter-spacing:1px;margin-top:2px}
.chart-legend{display:flex;gap:14px;justify-content:center;margin-top:8px}
.leg-item{display:flex;align-items:center;gap:5px;font-size:.7rem;color:var(--muted)}
.leg-dot{width:7px;height:7px;border-radius:50%}

/* Stat grid */
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.stat-card{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:12px;padding:13px 11px;
}
.stat-card .v{
  font-family:'Fraunces',serif;font-size:1.45rem;font-weight:600;line-height:1;margin-bottom:3px;
}
.stat-card .k{font-size:.62rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
.c-green{color:var(--win)}.c-red{color:var(--loss)}

/* Goal card */
.goal-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:16px;
  position:relative;overflow:hidden;
  transition:background .4s,box-shadow .4s;
}
.goal-card.achieved{
  background:linear-gradient(135deg,rgba(0,229,160,.06),var(--surface) 60%);
  box-shadow:0 0 0 1px rgba(0,229,160,.22);
}
.goal-head{
  display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;
}
.goal-title{font-family:'Syne',sans-serif;font-size:.84rem;font-weight:700}
.badge{
  font-family:'Syne',sans-serif;font-size:.62rem;font-weight:700;
  padding:3px 9px;border-radius:999px;letter-spacing:.8px;
  animation:badgePop .3s ease both;
}
.badge-green{background:rgba(0,229,160,.14);color:var(--win);border:1px solid rgba(0,229,160,.28)}
.badge-purple{background:rgba(108,99,255,.14);color:var(--accent3);border:1px solid rgba(108,99,255,.28)}
@keyframes badgePop{from{opacity:0;transform:scale(.7)}to{opacity:1;transform:scale(1)}}

.goal-row{display:flex;gap:7px;margin-bottom:10px}
.goal-inp{
  flex:1;padding:8px 11px;
  background:var(--surface2);border:1px solid var(--border);
  color:var(--text);border-radius:9px;
  font-family:'DM Mono',monospace;font-size:.83rem;
  transition:border .2s;
}
.goal-inp:focus{outline:none;border-color:var(--accent)}
.set-btn{
  padding:8px 15px;background:var(--accent);color:#0a0a0f;
  border:none;border-radius:9px;
  font-family:'Syne',sans-serif;font-size:.76rem;font-weight:700;
  cursor:pointer;transition:all .2s;white-space:nowrap;
}
.set-btn:hover{opacity:.82;transform:translateY(-1px)}

.prog-wrap{background:var(--surface2);border-radius:999px;height:7px;overflow:hidden;margin-bottom:7px}
.prog-bar{
  height:100%;border-radius:999px;
  background:linear-gradient(90deg,var(--accent),var(--accent3));
  transition:width .5s ease;
}
.prog-labels{display:flex;justify-content:space-between;font-size:.68rem;color:var(--muted)}

.achieve-banner{
  display:none;margin-top:10px;padding:9px 13px;
  background:rgba(0,229,160,.08);border:1px solid rgba(0,229,160,.2);
  border-radius:9px;font-size:.76rem;color:var(--win);text-align:center;
  animation:bannerSlide .4s ease both;
}
.achieve-banner.show{display:block}
@keyframes bannerSlide{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

/* Ring */
.ring-row{display:flex;align-items:center;gap:14px}
.ring-wrap{position:relative;width:88px;height:88px;flex-shrink:0}
.ring-wrap svg{width:88px;height:88px;transform:rotate(-90deg)}
.ring-bg{fill:none;stroke:var(--surface2);stroke-width:7}
.ring-fill{
  fill:none;stroke:var(--win);stroke-width:7;
  stroke-linecap:round;stroke-dasharray:226.2;stroke-dashoffset:226.2;
  transition:stroke-dashoffset .6s cubic-bezier(.4,0,.2,1),stroke .3s;
}
.ring-center{
  position:absolute;inset:0;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
}
.ring-num{font-family:'Fraunces',serif;font-size:1.15rem;font-weight:600;line-height:1}
.ring-den{font-size:.62rem;color:var(--muted)}
.ring-info{flex:1}
.ring-pct{font-family:'Fraunces',serif;font-size:1.35rem;font-weight:600;color:var(--accent)}
.ring-sub{font-size:.68rem;color:var(--muted);margin:2px 0 7px}

/* Export row */
.export-row{
  display:flex;gap:7px;margin-top:auto;padding-top:8px;
  border-top:1px solid var(--border);
}
.exp-btn{
  flex:1;padding:9px 8px;
  background:var(--surface2);border:1px solid var(--border);
  color:var(--text);border-radius:9px;
  font-family:'Syne',sans-serif;font-size:.74rem;font-weight:600;
  cursor:pointer;transition:all .2s;text-align:center;
}
.exp-btn:hover{border-color:var(--accent);color:var(--accent)}

/* ─── RIGHT PANEL ─── */
.right-panel{padding:26px 26px 48px}
@media(max-width:900px){.right-panel{padding:18px 14px 36px}}

.panel-header{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:20px;flex-wrap:wrap;gap:10px;
}
.panel-title{font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:800}
.panel-actions{display:flex;gap:8px}
.btn-ghost{
  padding:8px 16px;background:transparent;border:1px solid var(--border);
  color:var(--muted);border-radius:9px;
  font-family:'Syne',sans-serif;font-size:.78rem;font-weight:600;
  cursor:pointer;transition:all .2s;
}
.btn-ghost:hover{border-color:var(--accent2);color:var(--accent2)}
.btn-primary{
  padding:8px 16px;background:var(--accent);color:#0a0a0f;
  border:none;border-radius:9px;
  font-family:'Syne',sans-serif;font-size:.78rem;font-weight:700;
  cursor:pointer;transition:all .2s;
}
.btn-primary:hover{opacity:.85;transform:translateY(-1px)}

/* ─── IMPORT CARD ─── */
.import-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:18px;margin-bottom:22px;
}
.import-card-head{
  display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;
}
.import-card-title{font-family:'Syne',sans-serif;font-size:.88rem;font-weight:700}
.live-badge{
  display:inline-flex;align-items:center;gap:6px;
  padding:3px 10px;border-radius:999px;
  background:rgba(0,229,160,.1);border:1px solid rgba(0,229,160,.22);
  font-family:'Syne',sans-serif;font-size:.62rem;font-weight:700;color:var(--accent);
  letter-spacing:.8px;
}
.live-dot{
  width:6px;height:6px;border-radius:50%;background:var(--accent);
  animation:livePulse 2s infinite;
}
@keyframes livePulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.35;transform:scale(.75)}}

/* Drop zone */
.drop-zone{
  border:2px dashed var(--border);border-radius:13px;
  padding:30px 20px;text-align:center;cursor:pointer;
  background:var(--surface2);
  transition:all .3s;position:relative;overflow:hidden;
}
.drop-zone:hover,.drop-zone.dragover{
  border-color:var(--accent);background:rgba(0,229,160,.04);
  transform:translateY(-2px);
  box-shadow:0 14px 40px rgba(0,229,160,.1);
}
.drop-zone input[type=file]{display:none}
.drop-icon{
  width:40px;height:40px;margin:0 auto 10px;
  stroke:var(--accent);
  filter:drop-shadow(0 0 8px rgba(0,229,160,.45));
  animation:iconBob 3s ease-in-out infinite;
}
@keyframes iconBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
.drop-title{font-family:'Syne',sans-serif;font-size:.88rem;font-weight:700;margin-bottom:4px}
.drop-hint{font-size:.72rem;color:var(--muted)}

/* Import states */
.import-filename{
  display:none;align-items:center;gap:8px;
  margin-top:10px;padding:7px 12px;
  background:rgba(0,229,160,.07);border:1px solid rgba(0,229,160,.18);
  border-radius:8px;font-size:.74rem;color:var(--accent);
}
.import-filename svg{flex-shrink:0}

.import-processing{
  display:none;align-items:center;gap:10px;
  padding:12px 0;font-size:.78rem;color:var(--muted);
}
.spinner{
  width:17px;height:17px;border-radius:50%;
  border:2px solid var(--border);border-top-color:var(--accent);
  animation:spin .65s linear infinite;flex-shrink:0;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* Import stats */
.import-stats{
  display:none;grid-template-columns:repeat(3,1fr);gap:9px;margin-top:12px;
}
.imp-stat{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:10px;padding:11px;text-align:center;
  position:relative;overflow:hidden;
}
.imp-stat::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.imp-stat.is-win::before{background:var(--win);box-shadow:0 0 8px var(--win)}
.imp-stat.is-loss::before{background:var(--loss);box-shadow:0 0 8px var(--loss)}
.imp-stat.is-tie::before{background:var(--tie);box-shadow:0 0 8px var(--tie)}
.imp-stat .isn{font-family:'Fraunces',serif;font-size:1.4rem;font-weight:600;line-height:1;margin-bottom:2px}
.imp-stat.is-win .isn{color:var(--win)}
.imp-stat.is-loss .isn{color:var(--loss)}
.imp-stat.is-tie .isn{color:var(--tie)}
.imp-stat .isk{font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px}

/* Import actions */
.import-actions{display:none;gap:8px;margin-top:11px}
.btn-confirm{
  flex:1;padding:10px;background:var(--accent);color:#0a0a0f;
  border:none;border-radius:9px;
  font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;
  cursor:pointer;transition:all .2s;
}
.btn-confirm:hover{opacity:.85;transform:translateY(-1px)}
.btn-cancel{
  padding:10px 14px;background:transparent;border:1px solid var(--border);
  color:var(--muted);border-radius:9px;
  font-family:'Syne',sans-serif;font-size:.8rem;font-weight:600;
  cursor:pointer;transition:all .2s;
}
.btn-cancel:hover{border-color:var(--accent2);color:var(--accent2)}

.btn-dl-xlsx{
  display:none;width:100%;margin-top:9px;padding:10px;
  background:linear-gradient(135deg,var(--accent3),#9088ff);
  color:#fff;border:none;border-radius:9px;
  font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;
  cursor:pointer;transition:all .2s;
  align-items:center;justify-content:center;gap:7px;
}
.btn-dl-xlsx:hover{opacity:.85;transform:translateY(-1px);box-shadow:0 8px 24px rgba(108,99,255,.3)}

/* ─── TRADE TABLE ─── */
.table-scroll{
  border:1px solid var(--border);border-radius:var(--radius);
  overflow:hidden;overflow-x:auto;
}
table{width:100%;border-collapse:collapse;min-width:580px}
thead tr{background:var(--surface2);border-bottom:1px solid var(--border)}
th{
  padding:12px 15px;text-align:left;
  font-family:'Syne',sans-serif;font-size:.64rem;font-weight:700;
  text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);
  white-space:nowrap;
}
tbody tr{
  border-bottom:1px solid rgba(255,255,255,.04);
  transition:background .15s;
  animation:rowIn .25s ease both;
}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:rgba(255,255,255,.02)}
@keyframes rowIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
td{padding:10px 15px;font-size:.8rem;vertical-align:middle;white-space:nowrap}

.sl-num{color:var(--muted);font-size:.72rem}
.dir-badge{
  display:inline-flex;align-items:center;gap:4px;
  padding:3px 9px;border-radius:6px;
  font-family:'Syne',sans-serif;font-size:.68rem;font-weight:700;
}
.dir-buy{background:rgba(108,99,255,.15);color:var(--buy)}
.dir-sell{background:rgba(244,162,97,.15);color:var(--sell)}

.status-badge{
  display:inline-flex;align-items:center;gap:4px;
  padding:3px 9px;border-radius:6px;
  font-family:'Syne',sans-serif;font-size:.68rem;font-weight:700;
}
.s-win{background:rgba(0,229,160,.12);color:var(--win);border:1px solid rgba(0,229,160,.22)}
.s-loss{background:rgba(255,77,109,.12);color:var(--loss);border:1px solid rgba(255,77,109,.22)}
.s-tie{background:rgba(244,162,97,.12);color:var(--tie);border:1px solid rgba(244,162,97,.22)}
.s-pending{background:rgba(107,107,138,.1);color:var(--muted);border:1px solid var(--border)}
.s-dot{width:5px;height:5px;border-radius:50%;background:currentColor}

td select{
  background:var(--surface2);border:1px solid var(--border);
  color:var(--text);border-radius:7px;padding:4px 7px;
  font-family:'DM Mono',monospace;font-size:.75rem;
  cursor:pointer;transition:border .2s;margin-left:5px;
}
td select:focus{outline:none;border-color:var(--accent)}
.del-btn{
  background:transparent;border:1px solid transparent;
  color:var(--muted);padding:4px 7px;border-radius:7px;
  cursor:pointer;font-size:.85rem;transition:all .2s;
}
.del-btn:hover{border-color:var(--accent2);color:var(--accent2);background:rgba(255,77,109,.08)}

.asset-input{
  background:var(--surface2);border:1px solid var(--border);
  color:var(--text);border-radius:7px;padding:5px 9px;
  font-family:'DM Mono',monospace;font-size:.75rem;
  width:130px;transition:border .2s;
}
.asset-input:focus{outline:none;border-color:var(--accent)}
.asset-input::placeholder{color:var(--muted);font-size:.7rem}

.asset-cell{color:var(--muted);font-size:.75rem;max-width:140px;overflow:hidden;text-overflow:ellipsis}

/* Empty state */
.empty-state{
  padding:56px 20px;text-align:center;color:var(--muted);
}
.empty-state .emo{font-size:2.2rem;margin-bottom:10px}
.empty-state p{font-size:.82rem;line-height:1.6}

/* ─── ANALYTICS ─── */
#analyticsView{padding:26px;position:relative;z-index:2}
@media(max-width:900px){#analyticsView{padding:18px 14px}}

.filter-bar{
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:14px 18px;margin-bottom:22px;
}
.filter-bar select,
.filter-bar input[type=date]{
  padding:7px 11px;background:var(--surface2);border:1px solid var(--border);
  color:var(--text);border-radius:9px;
  font-family:'DM Mono',monospace;font-size:.8rem;
  cursor:pointer;color-scheme:dark;transition:border .2s;
}
body.light .filter-bar select,
body.light .filter-bar input[type=date]{color-scheme:light}
.filter-bar select:focus,.filter-bar input:focus{outline:none;border-color:var(--accent)}
.f-sep{color:var(--muted);font-size:.72rem}

.kpi-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));
  gap:13px;margin-bottom:22px;
}
.kpi-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:18px;
  position:relative;overflow:hidden;
}
.kpi-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:3px 3px 0 0;
}
.kpi-g::before{background:var(--win)}
.kpi-r::before{background:var(--loss)}
.kpi-p::before{background:var(--accent3)}
.kpi-label{
  font-family:'Syne',sans-serif;font-size:.65rem;font-weight:700;
  text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:9px;
}
.kpi-val{
  font-family:'Fraunces',serif;font-size:2.1rem;font-weight:600;
  line-height:1;margin-bottom:5px;
}
@media(max-width:600px){.kpi-val{font-size:1.7rem}}
.kpi-sub{font-size:.7rem;color:var(--muted)}
.kpi-sub.up{color:var(--win)}.kpi-sub.down{color:var(--loss)}

.charts-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
@media(max-width:900px){.charts-row{grid-template-columns:1fr}}
.chart-panel{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:18px;
}
.chart-panel-title{
  font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;
  margin-bottom:14px;
}

/* ─── TOAST ─── */
.toast-stack{position:fixed;bottom:26px;right:26px;z-index:999;display:flex;flex-direction:column;gap:7px}
.toast{
  padding:11px 16px;border-radius:11px;min-width:210px;
  background:var(--surface2);border:1px solid var(--border);
  font-size:.8rem;color:var(--text);
  box-shadow:var(--shadow);
  animation:toastIn .3s ease both;
}
.toast.ok{border-color:rgba(0,229,160,.38)}
.toast.err{border-color:rgba(255,77,109,.38)}
@keyframes toastIn{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}

/* ─── CONFETTI ─── */
.cfdot{
  position:absolute;width:6px;height:6px;border-radius:50%;
  pointer-events:none;animation:cfFly .9s ease both;
}
@keyframes cfFly{
  0%{opacity:1;transform:translate(0,0) scale(1)}
  100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(.25)}
}
@keyframes pulseRing{
  0%{box-shadow:0 0 0 0 rgba(0,229,160,.4)}
  70%{box-shadow:0 0 0 14px rgba(0,229,160,0)}
  100%{box-shadow:0 0 0 0 rgba(0,229,160,0)}
}

/* ─── SCROLLBAR ─── */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--surface)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px}
::-webkit-scrollbar-thumb:hover{background:var(--muted)}

/* ─── CURRENCY PAIRS TAB ─── */
#pairsView{padding:26px;position:relative;z-index:2}
@media(max-width:900px){#pairsView{padding:18px 14px}}

.pairs-filter-bar{
  display:flex;align-items:center;gap:12px;flex-wrap:wrap;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:14px 18px;margin-bottom:22px;
}
.pairs-filter-bar select,
.pairs-filter-bar input[type=date]{
  padding:8px 12px;background:var(--surface2);border:1px solid var(--border);
  color:var(--text);border-radius:9px;
  font-family:'DM Mono',monospace;font-size:.82rem;
  cursor:pointer;color-scheme:dark;transition:border .2s;
}
body.light .pairs-filter-bar select,
body.light .pairs-filter-bar input[type=date]{color-scheme:light}
.pairs-filter-bar select:focus,
.pairs-filter-bar input:focus{outline:none;border-color:var(--accent)}
.pairs-filter-label{
  font-family:'Syne',sans-serif;font-size:.72rem;font-weight:700;
  color:var(--muted);letter-spacing:1px;white-space:nowrap;
}

/* Best pair highlight */
.best-pair-banner{
  background:linear-gradient(135deg,rgba(0,229,160,.12),rgba(108,99,255,.08));
  border:1px solid rgba(0,229,160,.3);
  border-radius:var(--radius);padding:20px 24px;margin-bottom:22px;
  display:none;position:relative;overflow:hidden;
  animation:fadeUp .4s ease both;
}
.best-pair-banner::before{
  content:'';position:absolute;top:0;left:0;right:0;height:3px;
  background:linear-gradient(90deg,var(--accent),var(--accent3));
}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.best-pair-top{
  display:flex;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap;
}
.best-pair-crown{font-size:1.6rem}
.best-pair-name{
  font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:800;color:var(--accent);
}
.best-pair-subtitle{font-size:.72rem;color:var(--muted);margin-top:2px}
.best-pair-stats{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:10px;
}
.bps-card{
  background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.06);
  border-radius:10px;padding:11px 13px;
}
body.light .bps-card{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.06)}
.bps-val{font-family:'Fraunces',serif;font-size:1.3rem;font-weight:600;line-height:1;margin-bottom:3px}
.bps-key{font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px}

/* Pairs grid */
.pairs-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:14px;margin-bottom:22px;
}
.pair-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:16px;
  transition:transform .2s,box-shadow .2s;
  position:relative;overflow:hidden;cursor:pointer;
}
.pair-card:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(0,0,0,.3)}
.pair-card.best-card{
  border-color:rgba(0,229,160,.35);
  box-shadow:0 0 0 1px rgba(0,229,160,.15);
}
.pair-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
}
.pair-card.wr-high::before{background:var(--win)}
.pair-card.wr-mid::before{background:var(--tie)}
.pair-card.wr-low::before{background:var(--loss)}
.pc-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.pc-name{font-family:'Syne',sans-serif;font-size:.9rem;font-weight:700}
.pc-badge{
  font-family:'Syne',sans-serif;font-size:.62rem;font-weight:700;
  padding:2px 8px;border-radius:999px;
}
.pc-best{background:rgba(0,229,160,.15);color:var(--win);border:1px solid rgba(0,229,160,.28)}
.pc-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;margin-bottom:10px}
.pc-stat{text-align:center}
.pc-stat-val{font-family:'Fraunces',serif;font-size:1.1rem;font-weight:600;line-height:1}
.pc-stat-key{font-size:.6rem;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-top:2px}
.pc-wr{font-size:.72rem;color:var(--muted);margin-bottom:6px}
.pc-bar-wrap{background:var(--surface2);border-radius:999px;height:5px;overflow:hidden}
.pc-bar{height:100%;border-radius:999px;transition:width .6s ease}

/* Pair detail chart */
.pair-detail-section{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:20px;margin-bottom:22px;
  display:none;animation:fadeUp .4s ease both;
}
.pds-header{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:16px;flex-wrap:wrap;gap:10px;
}
.pds-title{font-family:'Syne',sans-serif;font-size:1rem;font-weight:800}
.pds-charts{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:700px){.pds-charts{grid-template-columns:1fr}}

/* Empty pairs state */
.pairs-empty{
  padding:60px 20px;text-align:center;color:var(--muted);
}
.pairs-empty .emo{font-size:2.4rem;margin-bottom:12px}
.pairs-empty p{font-size:.82rem;line-height:1.7}

/* ─── CONFIRM MODAL ─── */
.modal-overlay{
  display:none;position:fixed;inset:0;z-index:999;
  background:rgba(0,0,0,.65);backdrop-filter:blur(6px);
  align-items:center;justify-content:center;
}
.modal-overlay.open{display:flex}
.modal-box{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:28px 24px;
  max-width:340px;width:90%;
  box-shadow:0 24px 60px rgba(0,0,0,.7);
  animation:modalIn .22s ease both;
}
@keyframes modalIn{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:scale(1)}}
.modal-icon{font-size:2rem;margin-bottom:10px;text-align:center}
.modal-title{
  font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;
  text-align:center;margin-bottom:7px;
}
.modal-msg{
  font-size:.78rem;color:var(--muted);text-align:center;
  line-height:1.6;margin-bottom:20px;
}
.modal-btns{display:flex;gap:9px}
.modal-cancel{
  flex:1;padding:10px;background:transparent;
  border:1px solid var(--border);color:var(--muted);
  border-radius:9px;font-family:'Syne',sans-serif;
  font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s;
}
.modal-cancel:hover{border-color:var(--muted);color:var(--text)}
.modal-confirm{
  flex:1;padding:10px;background:var(--accent2);
  border:none;color:#fff;border-radius:9px;
  font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;
  cursor:pointer;transition:all .2s;
}
/* ─── STORAGE MANAGER ─── */
#storageView{padding:26px;position:relative;z-index:2}
@media(max-width:900px){#storageView{padding:18px 14px}}

.storage-intro{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:20px 24px;margin-bottom:22px;
  display:grid;grid-template-columns:1fr auto;gap:16px;align-items:start;
}
@media(max-width:600px){.storage-intro{grid-template-columns:1fr}}
.storage-intro-text{}
.storage-intro-title{
  font-family:'Syne',sans-serif;font-size:1rem;font-weight:800;margin-bottom:6px;
}
.storage-intro-desc{font-size:.78rem;color:var(--muted);line-height:1.7;margin-bottom:12px}

.storage-legend{display:flex;flex-wrap:wrap;gap:10px;margin-top:4px}
.leg-chip{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 10px;border-radius:8px;font-size:.68rem;
  font-family:'Syne',sans-serif;font-weight:600;
}
.leg-chip .cdot{width:8px;height:8px;border-radius:50%}
.lc-trades{background:rgba(0,229,160,.1);color:var(--win);border:1px solid rgba(0,229,160,.2)}
.lc-trades .cdot{background:var(--win)}
.lc-goal{background:rgba(108,99,255,.1);color:var(--accent3);border:1px solid rgba(108,99,255,.2)}
.lc-goal .cdot{background:var(--accent3)}
.lc-pb{background:rgba(244,162,97,.1);color:var(--tie);border:1px solid rgba(244,162,97,.2)}
.lc-pb .cdot{background:var(--tie)}

.storage-overview-cards{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:10px;
}
.sov-card{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:12px;padding:14px;text-align:center;
}
.sov-val{font-family:'Fraunces',serif;font-size:1.6rem;font-weight:600;line-height:1;margin-bottom:3px}
.sov-key{font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:1.2px}

.storage-actions-bar{
  display:flex;gap:9px;flex-wrap:wrap;margin-bottom:22px;
}
.btn-danger{
  padding:9px 16px;background:rgba(255,77,109,.12);
  border:1px solid rgba(255,77,109,.28);color:var(--loss);
  border-radius:9px;font-family:'Syne',sans-serif;
  font-size:.78rem;font-weight:700;cursor:pointer;transition:all .2s;
}
.btn-danger:hover{background:rgba(255,77,109,.22);transform:translateY(-1px)}
.btn-refresh{
  padding:9px 16px;background:var(--surface2);
  border:1px solid var(--border);color:var(--muted);
  border-radius:9px;font-family:'Syne',sans-serif;
  font-size:.78rem;font-weight:600;cursor:pointer;transition:all .2s;
  margin-left:auto;
}
.btn-refresh:hover{border-color:var(--accent);color:var(--accent)}

.storage-table-wrap{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);overflow:hidden;overflow-x:auto;
  margin-bottom:22px;
}
.storage-table-wrap table{width:100%;border-collapse:collapse;min-width:520px}
.storage-table-wrap thead tr{background:var(--surface2);border-bottom:1px solid var(--border)}
.storage-table-wrap th{
  padding:12px 16px;text-align:left;
  font-family:'Syne',sans-serif;font-size:.62rem;font-weight:700;
  text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);white-space:nowrap;
}
.storage-table-wrap tbody tr{
  border-bottom:1px solid rgba(255,255,255,.04);transition:background .15s;
}
.storage-table-wrap tbody tr:last-child{border-bottom:none}
.storage-table-wrap tbody tr:hover{background:rgba(255,255,255,.02)}
.storage-table-wrap td{padding:11px 16px;font-size:.78rem;vertical-align:middle}

.st-type-chip{
  display:inline-block;padding:2px 9px;border-radius:6px;
  font-family:'Syne',sans-serif;font-size:.62rem;font-weight:700;
}
.st-trades{background:rgba(0,229,160,.1);color:var(--win);border:1px solid rgba(0,229,160,.2)}
.st-goal{background:rgba(108,99,255,.1);color:var(--accent3);border:1px solid rgba(108,99,255,.2)}
.st-pb{background:rgba(244,162,97,.1);color:var(--tie);border:1px solid rgba(244,162,97,.2)}

.st-key{font-family:'DM Mono',monospace;font-size:.72rem;color:var(--muted)}
.st-date{font-weight:600;color:var(--text)}
.st-size{font-family:'DM Mono',monospace;font-size:.72rem;color:var(--muted)}
.st-count{font-family:'Fraunces',serif;font-size:1rem;font-weight:600}

.del-row-btn{
  padding:4px 10px;background:transparent;
  border:1px solid transparent;color:var(--muted);
  border-radius:7px;cursor:pointer;font-size:.75rem;
  font-family:'Syne',sans-serif;font-weight:600;
  transition:all .2s;white-space:nowrap;
}
.del-row-btn:hover{
  background:rgba(255,77,109,.1);border-color:rgba(255,77,109,.3);
  color:var(--loss);
}

.storage-empty{
  padding:52px 20px;text-align:center;color:var(--muted);
}
.storage-empty .emo{font-size:2.2rem;margin-bottom:10px}
.storage-empty p{font-size:.82rem;line-height:1.7}

.file-info-box{
  background:rgba(108,99,255,.07);border:1px solid rgba(108,99,255,.18);
  border-radius:12px;padding:16px 18px;margin-bottom:22px;
}
.fib-title{
  font-family:'Syne',sans-serif;font-size:.82rem;font-weight:700;
  margin-bottom:8px;color:var(--accent3);
}
.fib-body{font-size:.76rem;color:var(--muted);line-height:1.8}
.fib-body strong{color:var(--text)}

/* ─── P&L AMOUNT INPUT ─── */
.pnl-input{
  background:var(--surface2);border:1px solid var(--border);
  color:var(--text);border-radius:7px;padding:5px 9px;
  font-family:'DM Mono',monospace;font-size:.75rem;
  width:100px;transition:border .2s;
}
.pnl-input:focus{outline:none;border-color:var(--accent)}
.pnl-input::placeholder{color:var(--muted);font-size:.7rem}
.pnl-pos{color:var(--win);font-weight:600}
.pnl-neg{color:var(--loss);font-weight:600}
.pnl-zero{color:var(--muted)}

/* ─── STAT GRID 3-COL for P&L row ─── */
.stat-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:9px;margin-top:9px}
.pnl-stat-card{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:12px;padding:11px;text-align:center;
  border-top:2px solid var(--accent3);
}
.pnl-stat-card .v{
  font-family:'Fraunces',serif;font-size:1.1rem;font-weight:600;line-height:1;margin-bottom:3px;
}
.pnl-stat-card .k{font-size:.6rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase}

/* ─── MULTI-DATE IMPORT SUMMARY ─── */
.multidate-summary{
  display:none;margin-top:12px;
  background:var(--surface2);border:1px solid var(--border);
  border-radius:12px;overflow:hidden;
}
.mds-header{
  padding:10px 14px;background:rgba(108,99,255,.08);
  border-bottom:1px solid var(--border);
  font-family:'Syne',sans-serif;font-size:.78rem;font-weight:700;
  display:flex;align-items:center;justify-content:space-between;
}
.mds-badge{
  font-size:.62rem;padding:2px 8px;border-radius:999px;
  background:rgba(108,99,255,.15);color:var(--accent3);
  border:1px solid rgba(108,99,255,.25);
}
.mds-rows{max-height:180px;overflow-y:auto}
.mds-row{
  display:grid;grid-template-columns:120px 1fr 60px 60px 60px;
  gap:8px;padding:8px 14px;
  border-bottom:1px solid rgba(255,255,255,.03);
  font-size:.72rem;align-items:center;
}
.mds-row:last-child{border-bottom:none}
.mds-row-date{font-family:'Syne',sans-serif;font-weight:600;color:var(--accent)}
.mds-row-wins{color:var(--win)}
.mds-row-loss{color:var(--loss)}
.mds-row-tie{color:var(--tie)}
.mds-row-dup{color:var(--muted);font-size:.65rem}

/* ─── DUPLICATE BADGE ─── */
.dup-badge{
  display:inline-block;padding:1px 7px;border-radius:5px;
  font-size:.6rem;font-family:'Syne',sans-serif;font-weight:700;
  background:rgba(244,162,97,.12);color:var(--tie);
  border:1px solid rgba(244,162,97,.25);margin-left:4px;
}

/* ─── BACKUP/RESTORE ─── */
.backup-section{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:18px 20px;margin-bottom:18px;
}
.backup-title{
  font-family:'Syne',sans-serif;font-size:.88rem;font-weight:700;
  margin-bottom:6px;display:flex;align-items:center;gap:8px;
}
.backup-desc{font-size:.75rem;color:var(--muted);line-height:1.7;margin-bottom:14px}
.backup-actions{display:flex;gap:9px;flex-wrap:wrap;align-items:center}
.btn-backup{
  padding:9px 16px;
  background:linear-gradient(135deg,var(--accent3),#9088ff);
  color:#fff;border:none;border-radius:9px;
  font-family:'Syne',sans-serif;font-size:.78rem;font-weight:700;
  cursor:pointer;transition:all .2s;
}
.btn-backup:hover{opacity:.85;transform:translateY(-1px);box-shadow:0 8px 24px rgba(108,99,255,.3)}
.btn-restore{
  padding:9px 16px;
  background:rgba(0,229,160,.1);color:var(--accent);
  border:1px solid rgba(0,229,160,.25);border-radius:9px;
  font-family:'Syne',sans-serif;font-size:.78rem;font-weight:700;
  cursor:pointer;transition:all .2s;
}
.btn-restore:hover{background:rgba(0,229,160,.18);transform:translateY(-1px)}
.restore-file-input{display:none}
.backup-meta{font-size:.68rem;color:var(--muted);margin-top:8px}

/* ─── MAIN BALANCE (header) ─── */
.balance-wrap{
  display:flex;align-items:center;gap:6px;
  background:var(--surface2);border:1px solid var(--border);
  border-radius:10px;padding:5px 11px;
  transition:all .2s;position:relative;
  flex-shrink:0;
}
.balance-wrap:hover{border-color:var(--accent)}
.balance-label{
  font-family:'Syne',sans-serif;font-size:.62rem;font-weight:700;
  color:var(--muted);letter-spacing:1px;text-transform:uppercase;
  white-space:nowrap;
}
.balance-display{
  font-family:'Fraunces',serif;font-size:1rem;font-weight:600;
  color:var(--accent);white-space:nowrap;cursor:pointer;
  min-width:72px;text-align:right;
}
.balance-display:hover{text-decoration:underline dotted}
.balance-input-wrap{display:none;align-items:center;gap:4px}
.balance-input-wrap.active{display:flex}
.balance-display.hidden-when-editing{display:none}
#balanceInput{
  width:100px;padding:3px 7px;
  background:var(--bg);border:1px solid var(--accent);
  color:var(--text);border-radius:6px;
  font-family:'Fraunces',serif;font-size:.95rem;font-weight:600;
  text-align:right;
}
#balanceInput:focus{outline:none}
.balance-save-btn{
  background:var(--accent);border:none;color:#0a0a0f;
  border-radius:5px;padding:2px 8px;
  font-family:'Syne',sans-serif;font-size:.68rem;font-weight:700;
  cursor:pointer;white-space:nowrap;
}
.balance-hide-btn{
  background:transparent;border:none;color:var(--muted);
  cursor:pointer;font-size:.8rem;padding:0 2px;line-height:1;
  transition:color .2s;
}
.balance-hide-btn:hover{color:var(--text)}
.balance-blurred .balance-display{
  filter:blur(6px);user-select:none;pointer-events:none;
}

/* ─── EXPORT RANGE MODAL ─── */
.export-modal-overlay{
  display:none;position:fixed;inset:0;z-index:999;
  background:rgba(0,0,0,.65);backdrop-filter:blur(6px);
  align-items:center;justify-content:center;
}
.export-modal-overlay.open{display:flex}
.export-modal-box{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:28px 24px;
  max-width:420px;width:93%;
  box-shadow:0 24px 60px rgba(0,0,0,.7);
  animation:modalIn .22s ease both;
}
.export-modal-title{
  font-family:'Syne',sans-serif;font-size:1rem;font-weight:800;
  margin-bottom:18px;display:flex;align-items:center;gap:8px;
}
.export-range-row{
  display:flex;gap:10px;align-items:center;margin-bottom:14px;flex-wrap:wrap;
}
.export-range-row label{
  font-family:'Syne',sans-serif;font-size:.72rem;font-weight:700;
  color:var(--muted);width:38px;
}
.export-range-row input[type=date]{
  flex:1;padding:8px 11px;
  background:var(--surface2);border:1px solid var(--border);
  color:var(--text);border-radius:9px;
  font-family:'DM Mono',monospace;font-size:.82rem;
  color-scheme:dark;transition:border .2s;
}
body.light .export-range-row input[type=date]{color-scheme:light}
.export-range-row input:focus{outline:none;border-color:var(--accent)}
.export-type-tabs{
  display:flex;gap:7px;margin-bottom:18px;
}
.export-type-tab{
  flex:1;padding:8px;text-align:center;border-radius:9px;cursor:pointer;
  font-family:'Syne',sans-serif;font-size:.78rem;font-weight:700;
  border:1px solid var(--border);background:var(--surface2);color:var(--muted);
  transition:all .2s;
}
.export-type-tab.active{background:var(--accent);color:#0a0a0f;border-color:var(--accent)}
.export-modal-actions{display:flex;gap:9px;margin-top:4px}
.btn-export-go{
  flex:1;padding:11px;background:var(--accent);color:#0a0a0f;
  border:none;border-radius:9px;
  font-family:'Syne',sans-serif;font-size:.85rem;font-weight:700;
  cursor:pointer;transition:all .2s;
}
.btn-export-go:hover{opacity:.85;transform:translateY(-1px)}
.btn-export-cancel{
  padding:11px 16px;background:transparent;border:1px solid var(--border);
  color:var(--muted);border-radius:9px;
  font-family:'Syne',sans-serif;font-size:.82rem;font-weight:600;
  cursor:pointer;transition:all .2s;
}
.btn-export-cancel:hover{border-color:var(--muted);color:var(--text)}

/* ─── WEEKLY / MONTHLY GOALS ─── */
.period-goals-section{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:16px;
}
.period-goals-header{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:14px;flex-wrap:wrap;gap:8px;
}
.period-goals-title{
  font-family:'Syne',sans-serif;font-size:.84rem;font-weight:700;
}
.period-tabs{
  display:flex;gap:4px;background:var(--surface2);
  border-radius:8px;padding:3px;
}
.period-tab{
  font-family:'Syne',sans-serif;font-size:.68rem;font-weight:700;
  background:transparent;border:none;color:var(--muted);
  padding:4px 11px;border-radius:5px;cursor:pointer;transition:all .2s;
}
.period-tab.active{background:var(--accent3);color:#fff}
.period-goal-item{
  display:flex;align-items:center;gap:10px;margin-bottom:10px;
}
.period-goal-item:last-child{margin-bottom:0}
.pgi-label{
  font-family:'Syne',sans-serif;font-size:.72rem;font-weight:600;
  color:var(--muted);width:70px;flex-shrink:0;
}
.pgi-inp{
  width:72px;padding:5px 8px;
  background:var(--surface2);border:1px solid var(--border);
  color:var(--text);border-radius:7px;
  font-family:'DM Mono',monospace;font-size:.78rem;
  transition:border .2s;
}
.pgi-inp:focus{outline:none;border-color:var(--accent3)}
.pgi-set{
  padding:5px 10px;background:var(--accent3);color:#fff;
  border:none;border-radius:7px;
  font-family:'Syne',sans-serif;font-size:.68rem;font-weight:700;
  cursor:pointer;transition:all .2s;white-space:nowrap;
}
.pgi-set:hover{opacity:.85}
.pgi-prog-wrap{flex:1;background:var(--surface2);border-radius:999px;height:6px;overflow:hidden}
.pgi-prog-bar{height:100%;border-radius:999px;background:var(--accent3);transition:width .5s ease}
.pgi-val{
  font-family:'DM Mono',monospace;font-size:.7rem;color:var(--muted);
  white-space:nowrap;min-width:60px;text-align:right;
}
.pgi-badge{
  font-family:'Syne',sans-serif;font-size:.6rem;font-weight:700;
  padding:2px 7px;border-radius:999px;
}
.pgi-badge.achieved{background:rgba(0,229,160,.14);color:var(--win);border:1px solid rgba(0,229,160,.28)}
.pgi-badge.exceeded{background:rgba(108,99,255,.14);color:var(--accent3);border:1px solid rgba(108,99,255,.28)}

/* ─── MONTHLY SUMMARY REPORT ─── */
#summaryView{padding:26px;position:relative;z-index:2}
@media(max-width:900px){#summaryView{padding:18px 14px}}
.summary-filter-bar{
  display:flex;align-items:center;gap:12px;flex-wrap:wrap;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:14px 18px;margin-bottom:22px;
}
.summary-filter-bar label{
  font-family:'Syne',sans-serif;font-size:.72rem;font-weight:700;color:var(--muted);
}
.summary-filter-bar select{
  padding:8px 12px;background:var(--surface2);border:1px solid var(--border);
  color:var(--text);border-radius:9px;
  font-family:'DM Mono',monospace;font-size:.82rem;cursor:pointer;transition:border .2s;
}
.summary-filter-bar select:focus{outline:none;border-color:var(--accent)}
.summary-report{
  display:grid;gap:16px;
}
.sum-section{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:20px 22px;
}
.sum-section-title{
  font-family:'Syne',sans-serif;font-size:.88rem;font-weight:800;
  margin-bottom:16px;display:flex;align-items:center;gap:8px;
}
.sum-kpi-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;
}
.sum-kpi{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:12px;padding:14px;text-align:center;
}
.sum-kpi-val{
  font-family:'Fraunces',serif;font-size:1.5rem;font-weight:600;
  line-height:1;margin-bottom:4px;
}
.sum-kpi-key{font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
.sum-pair-table{width:100%;border-collapse:collapse;font-size:.78rem}
.sum-pair-table th{
  text-align:left;padding:8px 12px;
  font-family:'Syne',sans-serif;font-size:.62rem;font-weight:700;
  text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);
  border-bottom:1px solid var(--border);
}
.sum-pair-table td{padding:9px 12px;border-bottom:1px solid rgba(255,255,255,.04);vertical-align:middle}
.sum-pair-table tbody tr:last-child td{border-bottom:none}
.sum-pair-table tbody tr:hover{background:rgba(255,255,255,.02)}
.sum-day-table{width:100%;border-collapse:collapse;font-size:.78rem}
.sum-day-table th{
  text-align:left;padding:8px 12px;
  font-family:'Syne',sans-serif;font-size:.62rem;font-weight:700;
  text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);
  border-bottom:1px solid var(--border);
}
.sum-day-table td{padding:8px 12px;border-bottom:1px solid rgba(255,255,255,.04)}
.sum-day-table tbody tr:last-child td{border-bottom:none}
.sum-day-table tbody tr:hover{background:rgba(255,255,255,.02)}
.sum-highlight-best{color:var(--win);font-weight:600}
.sum-highlight-worst{color:var(--loss);font-weight:600}
.sum-empty{
  padding:48px 20px;text-align:center;color:var(--muted);
}
.sum-empty .emo{font-size:2rem;margin-bottom:10px}
.sum-empty p{font-size:.82rem;line-height:1.6}
.sum-badge-best{
  display:inline-block;padding:1px 8px;border-radius:5px;font-size:.62rem;
  font-family:'Syne',sans-serif;font-weight:700;
  background:rgba(0,229,160,.12);color:var(--win);border:1px solid rgba(0,229,160,.22);
  margin-left:5px;
}
.sum-badge-worst{
  display:inline-block;padding:1px 8px;border-radius:5px;font-size:.62rem;
  font-family:'Syne',sans-serif;font-weight:700;
  background:rgba(255,77,109,.12);color:var(--loss);border:1px solid rgba(255,77,109,.22);
  margin-left:5px;
}
/* ─── XLSX MEMORY NOTE ─── */
.xlsx-memory-note{
  display:flex;align-items:flex-start;gap:10px;
  background:rgba(108,99,255,.08);border:1px solid rgba(108,99,255,.18);
  border-radius:10px;padding:11px 14px;font-size:.73rem;line-height:1.5;
  color:var(--muted);margin-top:6px;
}
.xmn-icon{font-size:1.1rem;flex-shrink:0;margin-top:1px}
.xmn-text{flex:1}
.xmn-text strong{color:var(--text)}
.xmn-text em{color:var(--accent);font-style:normal;font-weight:700}
.xmn-clear{
  flex-shrink:0;background:rgba(255,77,109,.08);border:1px solid rgba(255,77,109,.2);
  color:var(--loss);border-radius:7px;padding:4px 10px;font-size:.7rem;
  cursor:pointer;white-space:nowrap;transition:all .2s;align-self:flex-start;
}
.xmn-clear:hover{background:rgba(255,77,109,.18)}
</style>
</head>
<body>

<div class="bg-glow"></div>

<!-- ═══════════ HEADER ═══════════ -->
<header>
  <div class="logo">Trade<em>Edge</em></div>
  <nav>
    <button class="active" id="tabTrades"   onclick="switchTab('trades')">📊 Trades</button>
    <button id="tabAnalytics"               onclick="switchTab('analytics')">📈 Analytics</button>
    <button id="tabPairs"                   onclick="switchTab('pairs')">💱 Currency Pairs</button>
    <button id="tabSummary"                 onclick="switchTab('summary')">📋 Monthly</button>
    <button id="tabStorage"                 onclick="switchTab('storage')">🗄️ Manager</button>
  </nav>
  <div class="balance-wrap" id="balanceWrap">
    <div class="acct-switcher" id="acctSwitcher">
      <span class="acct-label">Acct</span>
      <button class="acct-tab active" id="acctLive" onclick="switchAccount('live')">Live</button>
      <button class="acct-tab" id="acctDemo" onclick="switchAccount('demo')">Demo</button>
    </div>
    <div class="balance-label" id="balanceLabel">Balance</div>
    <div class="balance-display" id="balanceDisplay" onclick="editBalance()" title="Tap to edit">$0.00</div>
    <div class="balance-input-wrap" id="balanceInputWrap">
      <input type="number" id="balanceInput" step="0.01" placeholder="0.00" onkeydown="balanceKeydown(event)" oninput="autoSaveBalance()">
      <button class="balance-save-btn" onclick="saveBalance()">✓</button>
    </div>
    <button class="balance-hide-btn" id="balanceHideBtn" onclick="toggleBalanceVisibility()" title="Hide/Show balance">👁</button>
  </div>
  <div class="theme-strip" title="Choose theme">
    <div class="theme-dot td-dark active" id="tdDark"     onclick="applyTheme('dark')"     title="Dark"></div>
    <div class="theme-dot td-light"       id="tdLight"    onclick="applyTheme('light')"    title="Light"></div>
    <div class="theme-dot td-midnight"    id="tdMidnight" onclick="applyTheme('midnight')" title="Midnight Blue"></div>
    <div class="theme-dot td-amber"       id="tdAmber"    onclick="applyTheme('amber')"    title="Warm Amber"></div>
  </div>
  <button class="theme-btn" onclick="window.print()" title="Print current view" style="font-size:.75rem;width:auto;padding:0 10px;white-space:nowrap">🖨 Print</button>
</header>

<!-- ═══════════ TOAST STACK ═══════════ -->
<div class="toast-stack" id="toastStack"></div>

<!-- ═══════════════════════════════════════════ -->
<!--  TAB 1 — TRADES                             -->
<!-- ═══════════════════════════════════════════ -->
<div id="tradesView" class="view active">
  <div class="trades-layout">

    <!-- ── LEFT PANEL ── -->
    <div class="left-panel">

      <!-- 1. Date -->
      <div>
        <div class="section-label">Trading Date</div>
        <input type="date" class="date-inp" id="dateSelector" onchange="loadDateData()">
      </div>

      <!-- 2. Doughnut -->
      <div class="chart-card">
        <div class="section-label" style="text-align:center">Win / Loss Ratio</div>
        <div class="chart-wrap">
          <canvas id="pieChart"></canvas>
          <div class="chart-center">
            <div class="rate" id="chartRate">0%</div>
            <div class="lbl">WIN RATE</div>
          </div>
        </div>
        <div class="chart-legend">
          <div class="leg-item"><div class="leg-dot" style="background:var(--win)"></div>Wins</div>
          <div class="leg-item"><div class="leg-dot" style="background:var(--loss)"></div>Losses</div>
        </div>
      </div>

      <!-- 3. Stats -->
      <div>
        <div class="section-label">Session Stats</div>
        <div class="stat-grid">
          <div class="stat-card"><div class="v" id="sTot">0</div><div class="k">Total Trades</div></div>
          <div class="stat-card"><div class="v c-green" id="sWin">0</div><div class="k">Total Wins</div></div>
          <div class="stat-card"><div class="v c-red" id="sLoss">0</div><div class="k">Total Losses</div></div>
          <div class="stat-card"><div class="v" id="sRate">0.00%</div><div class="k">Win Rate</div></div>
        </div>
        <div class="stat-grid-3">
          <div class="pnl-stat-card"><div class="v" id="sPnlTotal">$0.00</div><div class="k">Total P&amp;L</div></div>
          <div class="pnl-stat-card"><div class="v pnl-pos" id="sPnlWin">$0.00</div><div class="k">Profit</div></div>
          <div class="pnl-stat-card"><div class="v pnl-neg" id="sPnlLoss">$0.00</div><div class="k">Loss</div></div>
        </div>
      </div>

      <!-- 4. Goal 1 — Win Rate -->
      <div class="goal-card" id="gc1">
        <div class="goal-head">
          <div class="goal-title">🎯 Win Rate Target</div>
          <div id="gb1"></div>
        </div>
        <div class="goal-row">
          <input type="number" class="goal-inp" id="gi1" placeholder="e.g. 70" min="0" max="100">
          <button class="set-btn" onclick="setGoal1()">SET</button>
        </div>
        <div class="prog-wrap"><div class="prog-bar" id="gpb1" style="width:0%"></div></div>
        <div class="prog-labels">
          <span id="gCurLabel">0.00%</span>
          <span id="gTgtLabel">Target: —</span>
        </div>
      </div>

      <!-- 5. Goal 2 — Total Wins -->
      <div class="goal-card" id="gc2">
        <div class="goal-head">
          <div class="goal-title">🏆 Target Winning Trades</div>
          <div id="gb2"></div>
        </div>
        <div class="goal-row">
          <input type="number" class="goal-inp" id="gi2" placeholder="e.g. 5" min="1">
          <button class="set-btn" onclick="setGoal2()">SET</button>
        </div>
        <div class="ring-row">
          <div class="ring-wrap">
            <svg viewBox="0 0 90 90">
              <circle class="ring-bg" cx="45" cy="45" r="36"/>
              <circle class="ring-fill" id="ringArc" cx="45" cy="45" r="36"/>
            </svg>
            <div class="ring-center">
              <div class="ring-num" id="rNum">0</div>
              <div class="ring-den" id="rDen">/—</div>
            </div>
          </div>
          <div class="ring-info">
            <div class="ring-pct" id="rPct">0.0%</div>
            <div class="ring-sub" id="rSub">Set a target</div>
            <div class="prog-wrap" style="margin-bottom:0">
              <div class="prog-bar" id="gpb2" style="width:0%"></div>
            </div>
          </div>
        </div>
        <div class="achieve-banner" id="achBanner">🎉 Daily Wins Goal Achieved!</div>
      </div>

      <!-- 6. Weekly/Monthly Goals -->
      <div class="period-goals-section">
        <div class="period-goals-header">
          <div class="period-goals-title">📅 Extended Goals</div>
          <div class="period-tabs">
            <button class="period-tab active" id="ptWeek" onclick="switchPeriodGoal('week')">Weekly</button>
            <button class="period-tab" id="ptMonth" onclick="switchPeriodGoal('month')">Monthly</button>
          </div>
        </div>
        <div id="periodGoalItems"><!-- rendered by JS --></div>
      </div>

      <!-- 7. Export -->
      <div class="export-row">
        <button class="exp-btn" onclick="openExportModal('csv')">📥 Export CSV</button>
        <button class="exp-btn" onclick="openExportModal('pdf')">📄 Export PDF</button>
      </div>

    </div><!-- /left-panel -->

    <!-- ── RIGHT PANEL ── -->
    <div class="right-panel">

      <!-- Panel header -->
      <div class="panel-header">
        <div class="panel-title" id="panelTitle">—</div>
        <div class="panel-actions">
          <button class="btn-ghost" onclick="resetTrades()">↺ Reset</button>
          <button class="btn-primary" onclick="addManualTrade()">+ Add Trade</button>
        </div>
      </div>

      <!-- ── IMPORT CARD ── -->
      <div class="import-card">
        <div class="import-card-head">
          <div class="import-card-title">📂 Import Trades from XLSX</div>
          <div class="live-badge"><span class="live-dot"></span>AUTO FORMAT</div>
        </div>

        <!-- Drop zone -->
        <div class="drop-zone" id="dropZone">
          <svg class="drop-icon" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          <div class="drop-title">Drop unformatted .xlsx file here</div>
          <div class="drop-hint">or click to browse — .xlsx files only</div>
          <input type="file" id="xlsxInput" accept=".xlsx">
        </div>

        <!-- File name -->
        <div class="import-filename" id="impFilename">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          <span id="impFilenameText"></span>
        </div>

        <!-- Processing -->
        <div class="import-processing" id="impProcessing">
          <div class="spinner"></div>
          <span>Parsing and formatting trade data…</span>
        </div>

        <!-- Stats -->
        <div class="import-stats" id="impStats">
          <div class="imp-stat is-win"><div class="isn" id="impW">0</div><div class="isk">Wins</div></div>
          <div class="imp-stat is-loss"><div class="isn" id="impL">0</div><div class="isk">Losses</div></div>
          <div class="imp-stat is-tie"><div class="isn" id="impT">0</div><div class="isk">Ties</div></div>
        </div>

        <!-- Duplicate + multi-date info row -->
        <div id="impMetaRow" style="display:none;margin-top:8px;font-size:.73rem;color:var(--muted);display:none;gap:14px;flex-wrap:wrap">
          <span>📅 <strong id="impDateCount" style="color:var(--accent3)">1</strong> date(s) detected</span>
          <span>⚠️ <strong id="impDupCount" style="color:var(--tie)">0</strong> duplicate(s) skipped</span>
          <span>✅ <strong id="impNewCount" style="color:var(--win)">0</strong> new trade(s) to insert</span>
        </div>

        <!-- Multi-date breakdown table -->
        <div class="multidate-summary" id="multidateSummary">
          <div class="mds-header">
            <span>📅 Multi-Date Import Preview</span>
            <span class="mds-badge" id="mdsTotal">0 trades</span>
          </div>
          <div class="mds-rows" id="mdsRows"></div>
        </div>

        <!-- Actions -->
        <div class="import-actions" id="impActions">
          <button class="btn-confirm" onclick="confirmImport()">✓ Insert into Trade Table</button>
          <button class="btn-cancel" onclick="cancelImport()">✕ Cancel</button>
        </div>

        <!-- Download formatted xlsx -->
        <button class="btn-dl-xlsx" id="btnDlXlsx" onclick="downloadXlsx()">
          ⬇ Download Formatted XLSX
        </button>

        <!-- XLSX Memory Note -->
        <div class="xlsx-memory-note" id="xlsxMemNote" style="display:none">
          <span class="xmn-icon">ℹ️</span>
          <div class="xmn-text">
            <strong>About the formatted XLSX</strong> — The file is <em>never saved</em> inside the app or localStorage.
            Clicking "Download" generates it fresh and saves it to your device only.
            The raw import rows stay in temporary JS memory until you
            <strong>Confirm</strong> or <strong>Cancel</strong> the import — they are wiped on either action.
          </div>
          <button class="xmn-clear" onclick="clearPendingImport()" title="Discard pending parsed rows from memory">🗑 Clear pending</button>
        </div>
      </div><!-- /import-card -->

      <!-- Trade Table -->
      <div id="tableContainer"></div>

    </div><!-- /right-panel -->
  </div><!-- /trades-layout -->
</div><!-- /tradesView -->

<!-- ═══════════════════════════════════════════ -->
<!--  TAB 2 — ANALYTICS                          -->
<!-- ═══════════════════════════════════════════ -->
<div id="analyticsView" class="view">
  <div class="filter-bar">
    <select id="periodSel" onchange="updateAnalytics()">
      <option value="daily">Daily View</option>
      <option value="weekly">Weekly View</option>
      <option value="monthly">Monthly View</option>
    </select>
    <span class="f-sep">From</span>
    <input type="date" id="aFrom" onchange="updateAnalytics()">
    <span class="f-sep">To</span>
    <input type="date" id="aTo" onchange="updateAnalytics()">
    <button class="exp-btn" style="padding:7px 14px;flex:none" onclick="openExportModal('pdf')">📄 Export PDF</button>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card kpi-g">
      <div class="kpi-label">Overall Win Rate</div>
      <div class="kpi-val" id="aKpi1">—</div>
      <div class="kpi-sub" id="aKpi1sub">—</div>
    </div>
    <div class="kpi-card kpi-p">
      <div class="kpi-label">Total Trades</div>
      <div class="kpi-val" id="aKpi2">—</div>
      <div class="kpi-sub" id="aKpi2sub">—</div>
    </div>
    <div class="kpi-card kpi-g">
      <div class="kpi-label">Best Day</div>
      <div class="kpi-val" style="font-size:1.25rem" id="aKpi3">—</div>
      <div class="kpi-sub" id="aKpi3sub">—</div>
    </div>
    <div class="kpi-card kpi-r">
      <div class="kpi-label">Worst Day</div>
      <div class="kpi-val" style="font-size:1.25rem" id="aKpi4">—</div>
      <div class="kpi-sub" id="aKpi4sub">—</div>
    </div>
  </div>

  <div class="charts-row">
    <div class="chart-panel">
      <div class="chart-panel-title">📈 Win Rate Trend</div>
      <canvas id="trendChart" height="220"></canvas>
    </div>
    <div class="chart-panel">
      <div class="chart-panel-title">📊 Trade Volume</div>
      <canvas id="volChart" height="220"></canvas>
    </div>
  </div>

  <!-- ─── HEATMAP CALENDAR ─── -->
  <div class="heatmap-section">
    <div class="heatmap-header">
      <div class="heatmap-title-text">🗓 Activity Heatmap</div>
      <div class="heatmap-controls">
        <select id="hmYear" onchange="renderHeatmap()"></select>
        <select id="hmMode" onchange="renderHeatmap()">
          <option value="wr">Win Rate</option>
          <option value="pnl">P&amp;L</option>
          <option value="count">Trade Count</option>
        </select>
        <div class="hm-legend">
          <span>Less</span>
          <div class="hm-legend-row">
            <div class="hm-swatch" style="background:var(--surface2)"></div>
            <div class="hm-swatch hm-g1"></div>
            <div class="hm-swatch hm-g2"></div>
            <div class="hm-swatch hm-g3"></div>
            <div class="hm-swatch hm-g4"></div>
          </div>
          <span>More</span>
        </div>
      </div>
    </div>
    <div class="heatmap-grid-wrap" id="heatmapGrid"></div>
    <div class="hm-tooltip-box" id="hmTooltip"></div>
  </div>

  <!-- ─── DOW + HOUR ANALYSIS ─── -->
  <div class="analytics-extra-grid">
    <div class="analysis-panel">
      <div class="analysis-panel-title">📅 Day-of-Week Win Rate</div>
      <div class="analysis-panel-sub">Which weekday performs best?</div>
      <div class="analysis-chart-wrap">
        <canvas id="dowChart"></canvas>
      </div>
    </div>
    <div class="analysis-panel">
      <div class="analysis-panel-title">🕐 Best / Worst Hour Analysis</div>
      <div class="analysis-panel-sub">Win rate by open trade hour — requires Open time in XLSX</div>
      <div class="analysis-chart-wrap" id="hourChartWrap">
        <canvas id="hourChart"></canvas>
      </div>
    </div>
  </div>

</div><!-- /analyticsView -->

<!-- ═══════════════════════════════════════════ -->
<!--  TAB 3 — CURRENCY PAIRS                     -->
<!-- ═══════════════════════════════════════════ -->
<div id="pairsView" class="view">

  <!-- Filter Bar -->
  <div class="pairs-filter-bar">
    <span class="pairs-filter-label">📅 Date Range:</span>
    <input type="date" id="pFrom" onchange="updatePairsView()">
    <span class="f-sep">→</span>
    <input type="date" id="pTo" onchange="updatePairsView()">
    <span class="pairs-filter-label" style="margin-left:8px">💱 Pair:</span>
    <select id="pairSelect" onchange="updatePairsView()">
      <option value="all">All Currency Pairs</option>
    </select>
    <span class="pairs-filter-label" style="margin-left:8px">📅 Date:</span>
    <select id="pairDateSelect" onchange="updatePairsView()">
      <option value="all">All Dates</option>
    </select>
  </div>

  <!-- Best Pair Banner -->
  <div class="best-pair-banner" id="bestPairBanner">
    <div class="best-pair-top">
      <div class="best-pair-crown">👑</div>
      <div>
        <div class="best-pair-name" id="bestPairName">—</div>
        <div class="best-pair-subtitle">🏆 Best Performing Currency Pair</div>
      </div>
    </div>
    <div class="best-pair-stats" id="bestPairStats"></div>
  </div>

  <!-- Selected Pair Detail Chart -->
  <div class="pair-detail-section" id="pairDetailSection">
    <div class="pds-header">
      <div class="pds-title" id="pdsTitle">Performance Detail</div>
    </div>
    <div class="pds-charts">
      <div class="chart-panel">
        <div class="chart-panel-title">🎯 Win / Loss / Tie Breakdown</div>
        <canvas id="pairPieChart" height="200"></canvas>
      </div>
      <div class="chart-panel">
        <div class="chart-panel-title">📈 Win Rate by Date</div>
        <canvas id="pairTrendChart" height="200"></canvas>
      </div>
    </div>
  </div>

  <!-- Pairs Grid -->
  <div id="pairsGridContainer"></div>

</div><!-- /pairsView -->

<!-- ═══════════════════════════════════════════ -->
<!--  TAB 4 — DATA MANAGER                       -->
<!-- ═══════════════════════════════════════════ -->
<div id="storageView" class="view">

  <!-- What is stored info box -->
  <div class="file-info-box">
    <div class="fib-title">📋 What is stored in your browser?</div>
    <div class="fib-body">
      <strong>Uploaded .xlsx files</strong> are <strong>never saved</strong> — they are read once into memory, parsed, then discarded immediately. Your original files remain only on your device.<br>
      What <strong>is</strong> stored in your browser's localStorage: the <strong>trade rows</strong> extracted from uploaded files (direction, asset, status), any <strong>manually added trades</strong>, and your <strong>daily goals</strong>. All data is stored locally in your browser only — nothing is sent to any server.
    </div>
  </div>

  <!-- ── BACKUP & RESTORE ── -->
  <div class="backup-section">
    <div class="backup-title">💾 Backup &amp; Restore</div>
    <div class="backup-desc">
      Export all your trades, goals, and settings as a single <strong>.json</strong> backup file. Restore it on any device to pick up exactly where you left off. Restoring will <strong>merge</strong> with existing data — new dates are added, existing dates are overwritten.
    </div>
    <div class="backup-actions">
      <button class="btn-backup" onclick="backupData()">⬇ Download Backup (.json)</button>
      <button class="btn-restore" onclick="document.getElementById('restoreInput').click()">⬆ Restore from Backup</button>
      <input type="file" id="restoreInput" class="restore-file-input" accept=".json" onchange="restoreData(this)">
    </div>
    <div class="backup-meta" id="backupMeta"></div>
  </div>

  <!-- Intro + overview -->
  <div class="storage-intro">
    <div class="storage-intro-text">
      <div class="storage-intro-title">🗄️ localStorage Data Manager</div>
      <div class="storage-intro-desc">All trade data is saved in your browser's localStorage, keyed by date. You can inspect and delete individual date entries or clear everything at once. Deleting a date's data is permanent and cannot be undone.</div>
      <div class="storage-legend">
        <span class="leg-chip lc-trades"><span class="cdot"></span>Trade Rows</span>
        <span class="leg-chip lc-goal"><span class="cdot"></span>Goals</span>
        <span class="leg-chip lc-pb"><span class="cdot"></span>Personal Best</span>
      </div>
    </div>
    <div class="storage-overview-cards" id="storageOverview"></div>
  </div>

  <!-- Action bar -->
  <div class="storage-actions-bar">
    <button class="btn-danger" onclick="clearAllStorage()">🗑 Delete ALL Data</button>
    <button class="btn-refresh" onclick="renderStorageTable()">↺ Refresh</button>
  </div>

  <!-- Storage Table -->
  <div id="storageTableContainer"></div>

</div><!-- /storageView -->

<!-- ═══════════════════════════════════════════ -->
<!--  TAB 5 — MONTHLY SUMMARY                    -->
<!-- ═══════════════════════════════════════════ -->
<div id="summaryView" class="view">
  <div class="summary-filter-bar">
    <label>📅 Month:</label>
    <select id="summaryMonthSel" onchange="renderMonthlySummary()"></select>
    <label style="margin-left:12px">Year:</label>
    <select id="summaryYearSel" onchange="populateSummaryMonths(); renderMonthlySummary()"></select>
  </div>
  <div id="summaryReportContainer">
    <div class="sum-empty"><div class="emo">📋</div><p>Select a month above to generate your summary report.</p></div>
  </div>
</div><!-- /summaryView -->

<!-- ═══════════════════════════════════════════ -->
<!--  EXPORT RANGE MODAL                         -->
<!-- ═══════════════════════════════════════════ -->
<div class="export-modal-overlay" id="exportModal" onclick="exportModalOverlayClick(event)">
  <div class="export-modal-box">
    <div class="export-modal-title">📤 Export Report</div>
    <div class="export-type-tabs">
      <div class="export-type-tab active" id="expTabCSV" onclick="setExportType('csv')">📥 CSV</div>
      <div class="export-type-tab" id="expTabPDF" onclick="setExportType('pdf')">📄 PDF</div>
    </div>
    <div class="export-range-row">
      <label>From</label>
      <input type="date" id="expFrom">
    </div>
    <div class="export-range-row">
      <label>To</label>
      <input type="date" id="expTo">
    </div>
    <div class="export-modal-actions">
      <button class="btn-export-go" onclick="runExport()">Generate &amp; Download</button>
      <button class="btn-export-cancel" onclick="closeExportModal()">Cancel</button>
    </div>
  </div>
</div>


<div class="modal-overlay" id="confirmModal" onclick="overlayClick(event)">
  <div class="modal-box">
    <div class="modal-icon">⚠️</div>
    <div class="modal-title" id="modalTitle">Reset Trades?</div>
    <div class="modal-msg" id="modalMsg">This will remove all trades for this date. Goals will be kept.</div>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeModal()">Cancel</button>
      <button class="modal-confirm" id="modalConfirmBtn" onclick="doModalConfirm()">Reset</button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════ -->
<!--  JAVASCRIPT                                 -->
<!-- ═══════════════════════════════════════════ -->
<script>
'use strict';

// ──────────────────────────────
// STATE
// ──────────────────────────────
let trades = [];          // current date's trade array
let currentDate = '';
let goal1 = null;         // win-rate target
let goal2 = null;         // wins count target
let winsGoalFired = false;// prevent re-triggering celebration
let pieInst = null;
let trendInst = null;
let volInst = null;
let parsedImport = [];    // holds xlsx parsed rows before confirm
let isMultiDate  = false; // flag: parsed file has multiple dates
let activePeriodGoal = 'week'; // 'week' | 'month'
let exportType = 'csv';   // 'csv' | 'pdf'
let balanceHidden = false;
let modalCallback = null; // CRITICAL: must be global
let _balanceSaveTimer = null;

// ──────────────────────────────
// BOOT
// ──────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
  const today = new Date().toISOString().slice(0,10);
  document.getElementById('dateSelector').value = today;

  // Analytics default range: last 30 days → today
  const from30 = new Date();
  from30.setDate(from30.getDate() - 30);
  document.getElementById('aFrom').value = from30.toISOString().slice(0,10);
  document.getElementById('aTo').value   = today;

  loadTheme();
  loadAccount();
  initPie();
  setupDropZone();
  loadDateData();
  loadBalance();
  populateSummaryYears();
  populateSummaryMonths();
  populateHeatmapYears();
});

// ──────────────────────────────
// TAB SWITCHING
// ──────────────────────────────
function switchTab(tab) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  if (tab === 'trades') {
    document.getElementById('tradesView').classList.add('active');
    document.getElementById('tabTrades').classList.add('active');
  } else if (tab === 'analytics') {
    document.getElementById('analyticsView').classList.add('active');
    document.getElementById('tabAnalytics').classList.add('active');
    updateAnalytics();
  } else if (tab === 'pairs') {
    document.getElementById('pairsView').classList.add('active');
    document.getElementById('tabPairs').classList.add('active');
    initPairsView();
  } else if (tab === 'summary') {
    document.getElementById('summaryView').classList.add('active');
    document.getElementById('tabSummary').classList.add('active');
    populateSummaryYears();
    populateSummaryMonths();
    renderMonthlySummary();
  } else if (tab === 'storage') {
    document.getElementById('storageView').classList.add('active');
    document.getElementById('tabStorage').classList.add('active');
    renderStorageTable();
  }
}

// ──────────────────────────────
// THEME
// ──────────────────────────────
// ──────────────────────────────
// THEME SYSTEM
// ──────────────────────────────
const ALL_THEMES = ['dark','light','midnight','amber'];

function applyTheme(name) {
  // Remove all theme classes
  document.body.classList.remove('light','theme-midnight','theme-amber');
  if (name === 'light')    document.body.classList.add('light');
  if (name === 'midnight') document.body.classList.add('theme-midnight');
  if (name === 'amber')    document.body.classList.add('theme-amber');
  // Update nav active dot
  ALL_THEMES.forEach(t => {
    const el = document.getElementById('td' + t.charAt(0).toUpperCase() + t.slice(1));
    if (el) el.classList.toggle('active', t === name);
  });
  localStorage.setItem('te_theme', name);
}

function loadTheme() {
  applyTheme(localStorage.getItem('te_theme') || 'dark');
}

// Legacy (kept for any stray calls)
function toggleTheme() {
  applyTheme(document.body.classList.contains('light') ? 'dark' : 'light');
}

// ──────────────────────────────
// MULTI-ACCOUNT
// ──────────────────────────────
let activeAccount = 'live'; // 'live' | 'demo'

function switchAccount(acct) {
  activeAccount = acct;
  localStorage.setItem('te_active_account', acct);
  document.getElementById('acctLive').classList.toggle('active', acct === 'live');
  document.getElementById('acctDemo').classList.toggle('active', acct === 'demo');
  const lbl = document.getElementById('balanceLabel');
  if (lbl) lbl.textContent = acct === 'demo' ? 'Demo Balance' : 'Live Balance';
  renderBalanceDisplay();
  // Reload trades, goals, and analytics for the switched account
  loadDateData();
  toast((acct === 'demo' ? '🔵 Demo' : '🟢 Live') + ' account active', 'ok');
}

function loadAccount() {
  activeAccount = localStorage.getItem('te_active_account') || 'live';
  document.getElementById('acctLive').classList.toggle('active', activeAccount === 'live');
  document.getElementById('acctDemo').classList.toggle('active', activeAccount === 'demo');
  const lbl = document.getElementById('balanceLabel');
  if (lbl) lbl.textContent = activeAccount === 'demo' ? 'Demo Balance' : 'Live Balance';
}

// Override renderBalanceDisplay to read per-account key
// (redefine after original — same name is fine in JS, last wins)
function renderBalanceDisplay() {
  const key = activeAccount === 'demo' ? 'demo_balance' : 'main_balance';
  const val = parseFloat(localStorage.getItem(key) || '0');
  const sign = val < 0 ? '-' : '';
  document.getElementById('balanceDisplay').textContent = sign + '$' + Math.abs(val).toFixed(2);
}

// ──────────────────────────────
// EXTRACT TIME FROM EXCEL DATETIME
// ──────────────────────────────
// Input:  "2026-02-23 16:56:16"  →  Output: "04:56:16 PM"
// Input:  "2026-02-23T09:05:00"  →  Output: "09:05:00 AM"
function extractTime12h(raw) {
  if (!raw && raw !== 0) return '';
  const s = String(raw).trim();
  // Match "YYYY-MM-DD HH:MM:SS" or "YYYY-MM-DDTHH:MM:SS"
  const m = s.match(/[\sT](\d{2}):(\d{2}):(\d{2})/);
  if (!m) return '';
  let h = parseInt(m[1], 10);
  const mm = m[2];
  const ss = m[3];
  const period = h >= 12 ? 'PM' : 'AM';
  h = h % 12 || 12;
  return `${String(h).padStart(2,'0')}:${mm}:${ss} ${period}`;
}

// ──────────────────────────────
// HEATMAP CALENDAR
// ──────────────────────────────
function populateHeatmapYears() {
  const sel = document.getElementById('hmYear');
  if (!sel) return;
  const years = new Set([new Date().getFullYear()]);
  for (let k = 0; k < localStorage.length; k++) {
    const key = localStorage.key(k);
    if (key && key.startsWith(tradesPrefix())) {
      const yr = parseInt(key.slice(7, 11));
      if (!isNaN(yr)) years.add(yr);
    }
  }
  const sorted = [...years].sort((a,b) => b-a);
  const cur = sel.value || String(new Date().getFullYear());
  sel.innerHTML = sorted.map(y => `<option value="${y}" ${String(y)===cur?'selected':''}>${y}</option>`).join('');
}

function renderHeatmap() {
  populateHeatmapYears();
  const grid  = document.getElementById('heatmapGrid');
  const tip   = document.getElementById('hmTooltip');
  if (!grid) return;

  const year = parseInt(document.getElementById('hmYear')?.value || new Date().getFullYear());
  const mode = document.getElementById('hmMode')?.value || 'wr';

  // Collect daily data for the year
  const dayData = {};
  const start = new Date(year, 0, 1);
  const end   = new Date(year, 11, 31);
  const cur2  = new Date(start);
  while (cur2 <= end) {
    const ds   = cur2.toISOString().slice(0,10);
    const raw  = localStorage.getItem(tradesKey(ds));
    if (raw) {
      const ts  = JSON.parse(raw);
      const w   = ts.filter(t => t.status === 'Win').length;
      const l   = ts.filter(t => t.status === 'Loss').length;
      const s   = w + l;
      let pnl   = 0;
      ts.forEach(t => { const v = parseFloat(t.pnl); if (!isNaN(v)) pnl += v; });
      dayData[ds] = { w, l, s, count: ts.length, wr: s ? w/s*100 : 0, pnl };
    }
    cur2.setDate(cur2.getDate() + 1);
  }

  // max value for scaling
  const vals = Object.values(dayData);
  const maxPnl   = Math.max(...vals.map(d => Math.abs(d.pnl)), 1);
  const maxCount = Math.max(...vals.map(d => d.count), 1);

  function cellClass(ds) {
    const d = dayData[ds];
    if (!d) return '';
    if (mode === 'wr') {
      if (d.s === 0) return '';
      const v = d.wr;
      if (d.l > d.w) {
        // net loss day → red scale
        const lvl = v < 25 ? 4 : v < 40 ? 3 : v < 50 ? 2 : 1;
        return `hm-r${lvl}`;
      }
      return v >= 80 ? 'hm-g4' : v >= 60 ? 'hm-g3' : v >= 40 ? 'hm-g2' : 'hm-g1';
    } else if (mode === 'pnl') {
      const ratio = Math.abs(d.pnl) / maxPnl;
      const lvl = ratio >= .75 ? 4 : ratio >= .5 ? 3 : ratio >= .2 ? 2 : ratio > 0 ? 1 : 0;
      if (!lvl) return '';
      return d.pnl >= 0 ? `hm-g${lvl}` : `hm-r${lvl}`;
    } else {
      const ratio = d.count / maxCount;
      return ratio >= .75 ? 'hm-p4' : ratio >= .5 ? 'hm-p3' : ratio >= .2 ? 'hm-p2' : ratio > 0 ? 'hm-p1' : '';
    }
  }

  function cellTip(ds) {
    const d = dayData[ds];
    if (!d) return ds + ': No trades';
    const pnlStr = (d.pnl >= 0 ? '+' : '') + '$' + d.pnl.toFixed(2);
    return `${ds} | ${d.count} trades | ${d.w}W / ${d.l}L | WR ${d.s ? d.wr.toFixed(0) : 0}% | P&L ${pnlStr}`;
  }

  // Build week columns from Jan 1
  const startDow = start.getDay(); // 0=Sun
  const weeks = [];
  let wk = [];
  for (let p = 0; p < startDow; p++) wk.push(null); // pad
  const dc = new Date(start);
  while (dc.getFullYear() === year) {
    wk.push(dc.toISOString().slice(0,10));
    if (wk.length === 7) { weeks.push(wk); wk = []; }
    dc.setDate(dc.getDate()+1);
  }
  if (wk.length) { while(wk.length < 7) wk.push(null); weeks.push(wk); }

  // Month label row
  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const monthLabels = new Array(weeks.length).fill('');
  weeks.forEach((wk, wi) => {
    wk.forEach(ds => {
      if (!ds) return;
      const d = new Date(ds + 'T12:00:00');
      if (d.getDate() <= 7 && monthLabels.slice(0, wi).every(l => l !== MON[d.getMonth()])) {
        monthLabels[wi] = MON[d.getMonth()];
      }
    });
  });

  const monthRowHTML = `<div class="heatmap-month-row">${monthLabels.map(l => `<div class="hm-month-lbl">${l}</div>`).join('')}</div>`;

  const weeksHTML = weeks.map(wk =>
    `<div class="hm-week">${wk.map(ds => {
      if (!ds) return `<div class="hm-cell" style="opacity:0"></div>`;
      const cls = cellClass(ds);
      return `<div class="hm-cell ${cls}" data-d="${ds}" data-tip="${cellTip(ds)}"
        onmouseenter="showHmTip(event,this)" onmouseleave="document.getElementById('hmTooltip').style.display='none'"></div>`;
    }).join('')}</div>`
  ).join('');

  const dayLabels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const dayHTML   = dayLabels.map(d => `<div class="hm-day-lbl">${d.slice(0,1)}</div>`).join('');

  grid.innerHTML = `
    ${monthRowHTML}
    <div class="heatmap-body">
      <div class="hm-day-labels">${dayHTML}</div>
      <div class="heatmap-weeks">${weeksHTML}</div>
    </div>`;
}

function showHmTip(event, el) {
  const tip = document.getElementById('hmTooltip');
  tip.textContent = el.dataset.tip;
  tip.style.display = 'block';
  tip.style.left = (event.clientX + 14) + 'px';
  tip.style.top  = (event.clientY - 38) + 'px';
}

// ──────────────────────────────
// DAY-OF-WEEK ANALYSIS
// ──────────────────────────────
let dowInst = null;

function renderDOWChart(allTrades) {
  const ctx = document.getElementById('dowChart');
  if (!ctx) return;
  if (dowInst) { dowInst.destroy(); dowInst = null; }

  const DAYS   = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const stats  = DAYS.map(() => ({ w:0, l:0, total:0 }));

  allTrades.forEach(t => {
    const dt = new Date((t.date || currentDate) + 'T12:00:00');
    const i  = dt.getDay();
    stats[i].total++;
    if (t.status === 'Win')  stats[i].w++;
    if (t.status === 'Loss') stats[i].l++;
  });

  // Only show days that have data
  const activeDays = DAYS.filter((_, i) => stats[i].total > 0);
  const wrData     = DAYS.filter((_, i) => stats[i].total > 0)
                         .map((_, i) => {
                           const idx = DAYS.indexOf(activeDays[i]);
                           return stats[idx].total ? (stats[idx].w / stats[idx].total * 100) : 0;
                         });
  const tradeData  = activeDays.map((d, i) => stats[DAYS.indexOf(d)].total);

  const bgColors = wrData.map(v => v >= 60 ? 'rgba(0,229,160,.75)' : v >= 40 ? 'rgba(244,162,97,.75)' : 'rgba(255,77,109,.75)');
  const base = { family:'DM Mono', size:10 };
  const grid = 'rgba(255,255,255,0.05)';
  const tick = '#6b6b8a';

  if (!activeDays.length) {
    const wrap = document.getElementById('hourChartWrap'); // reuse pattern
    return;
  }

  dowInst = new Chart(ctx.getContext('2d'), {
    type: 'bar',
    data: {
      labels: activeDays,
      datasets: [
        {
          label: 'Win Rate %', data: wrData,
          backgroundColor: bgColors, borderRadius: 6,
          yAxisID: 'yWR', order: 1
        },
        {
          label: 'Total Trades', data: tradeData,
          backgroundColor: 'rgba(108,99,255,.22)',
          borderColor: 'rgba(108,99,255,.5)',
          borderWidth: 1, borderRadius: 4,
          yAxisID: 'yVol', order: 2
        }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false, animation: { duration: 500 },
      scales: {
        x: { ticks:{ font:base, color:tick }, grid:{ color:grid } },
        yWR:  { position:'left',  min:0, max:100, ticks:{ font:base, color:tick, callback: v => v+'%' }, grid:{ color:grid } },
        yVol: { position:'right', beginAtZero:true, ticks:{ font:base, color:tick }, grid:{ display:false } }
      },
      plugins: {
        legend: { display:true, labels:{ font:base, color:tick, boxWidth:12 } },
        tooltip: { callbacks: { label: c => c.dataset.label === 'Win Rate %' ? ` WR: ${c.parsed.y.toFixed(1)}%` : ` Trades: ${c.parsed.y}` } }
      }
    }
  });
}

// ──────────────────────────────
// HOUR ANALYSIS
// ──────────────────────────────
let hourInst = null;

function renderHourChart(allTrades) {
  const ctx  = document.getElementById('hourChart');
  const wrap = document.getElementById('hourChartWrap');
  if (!ctx || !wrap) return;
  if (hourInst) { hourInst.destroy(); hourInst = null; }

  // Only trades with openTime
  const withTime = allTrades.filter(t => t.openTime && t.openTime.length > 0);

  if (!withTime.length) {
    wrap.innerHTML = `<div class="no-time-note">
      <div class="emo">🕐</div>
      No open time data found.<br>Import a file with an <strong>Open time</strong> column<br>(e.g. <em>2026-02-23 16:56:16</em>) to see hour analysis.
    </div>`;
    return;
  }

  // Restore canvas if it was replaced
  if (!document.getElementById('hourChart')) {
    wrap.innerHTML = '<canvas id="hourChart"></canvas>';
  }

  // Group by hour (0–23)
  const hStats = {};
  withTime.forEach(t => {
    // openTime format: "hh:mm:ss AM/PM"
    const m = t.openTime.match(/^(\d{1,2}):(\d{2}):(\d{2})\s*(AM|PM)/i);
    if (!m) return;
    let h = parseInt(m[1], 10);
    const per = m[4].toUpperCase();
    if (per === 'PM' && h !== 12) h += 12;
    if (per === 'AM' && h === 12) h = 0;
    if (!hStats[h]) hStats[h] = { w:0, l:0, total:0 };
    hStats[h].total++;
    if (t.status === 'Win')  hStats[h].w++;
    if (t.status === 'Loss') hStats[h].l++;
  });

  const hours  = Object.keys(hStats).map(Number).sort((a,b) => a-b);
  const labels = hours.map(h => {
    const per = h >= 12 ? 'PM' : 'AM';
    const hh  = h % 12 || 12;
    return `${hh}${per}`;
  });
  const wrs    = hours.map(h => hStats[h].total ? (hStats[h].w / hStats[h].total * 100) : 0);
  const counts = hours.map(h => hStats[h].total);
  const bgCol  = wrs.map(v => v >= 60 ? 'rgba(0,229,160,.80)' : v >= 40 ? 'rgba(244,162,97,.80)' : 'rgba(255,77,109,.80)');

  const base = { family:'DM Mono', size:10 };
  const grid = 'rgba(255,255,255,0.05)';
  const tick = '#6b6b8a';

  // Ensure canvas exists
  let c = document.getElementById('hourChart');
  if (!c) {
    wrap.innerHTML = '<canvas id="hourChart"></canvas>';
    c = document.getElementById('hourChart');
  }

  hourInst = new Chart(c.getContext('2d'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Win Rate %', data: wrs,
          backgroundColor: bgCol, borderRadius: 5,
          yAxisID: 'yWR', order: 1
        },
        {
          label: 'Trades', data: counts,
          backgroundColor: 'rgba(108,99,255,.22)',
          borderColor: 'rgba(108,99,255,.5)',
          borderWidth: 1, borderRadius: 3,
          yAxisID: 'yVol', order: 2
        }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false, animation: { duration: 500 },
      scales: {
        x: { ticks:{ font:base, color:tick }, grid:{ color:grid } },
        yWR:  { position:'left',  min:0, max:100, ticks:{ font:base, color:tick, callback: v => v+'%' }, grid:{ color:grid } },
        yVol: { position:'right', beginAtZero:true, ticks:{ font:base, color:tick }, grid:{ display:false } }
      },
      plugins: {
        legend: { display:true, labels:{ font:base, color:tick, boxWidth:12 } },
        tooltip: { callbacks: { label: c => c.dataset.label === 'Win Rate %' ? ` WR: ${c.parsed.y.toFixed(1)}%` : ` Trades: ${c.parsed.y}` } }
      }
    }
  });
}

// ──────────────────────────────
// DATE LOAD
// ──────────────────────────────
function loadDateData() {
  currentDate = document.getElementById('dateSelector').value;
  if (!currentDate) return;

  // Panel title
  const d = new Date(currentDate + 'T12:00:00');
  document.getElementById('panelTitle').textContent =
    d.toLocaleDateString('en-US', {weekday:'long',year:'numeric',month:'long',day:'numeric'});

  // Trades (account-scoped)
  const raw = localStorage.getItem(tradesKey(currentDate));
  trades = raw ? JSON.parse(raw) : [];

  // Goals (account-scoped)
  const g1 = localStorage.getItem(goalKey(currentDate));
  goal1 = g1 !== null ? parseFloat(g1) : null;
  document.getElementById('gi1').value = goal1 !== null ? goal1 : '';

  const g2 = localStorage.getItem(winsGoalKey(currentDate));
  goal2 = g2 !== null ? parseInt(g2) : null;
  document.getElementById('gi2').value = goal2 !== null ? goal2 : '';

  winsGoalFired = false;
  document.getElementById('achBanner').classList.remove('show');
  document.getElementById('gc2').classList.remove('achieved');

  renderTable();
  updateStats();
  renderPeriodGoals();
}

function saveData() {
  if (currentDate)
    localStorage.setItem(tradesKey(currentDate), JSON.stringify(trades));
}

// ──────────────────────────────
// TRADE OPERATIONS
// ──────────────────────────────
function addManualTrade() {
  trades.push({ sl: trades.length + 1, direction: 'Buy', status: '', asset: '', pnl: '' });
  saveData();
  renderTable();
  updateStats();
  toast('Trade row added', 'ok');
}

function updateTrade(idx, field, val) {
  if (!trades[idx]) return;
  trades[idx][field] = val;
  saveData();
  // Skip re-render for text inputs to avoid cursor jump
  if (field !== 'asset' && field !== 'pnl') renderTable();
  updateStats();
}

function deleteTrade(idx) {
  trades.splice(idx, 1);
  trades.forEach((t, i) => t.sl = i + 1);
  saveData();
  renderTable();
  updateStats();
}

function resetTrades() {
  showModal(
    'Reset Trades?',
    'This will remove all trades for this date. Goals will be kept.',
    'Reset',
    () => {
      trades = [];
      saveData();
      renderTable();
      updateStats();
      toast('Trades reset', 'ok');
    }
  );
}

// ── MODAL HELPERS ──
function showModal(title, msg, confirmLabel, onConfirm) {
  document.getElementById('modalTitle').textContent      = title;
  document.getElementById('modalMsg').textContent        = msg;
  document.getElementById('modalConfirmBtn').textContent = confirmLabel;
  modalCallback = onConfirm;
  document.getElementById('confirmModal').classList.add('open');
}

function closeModal() {
  document.getElementById('confirmModal').classList.remove('open');
  modalCallback = null;
}

function doModalConfirm() {
  const cb = modalCallback;
  closeModal();
  if (typeof cb === 'function') cb();
}

function overlayClick(e) {
  if (e.target === document.getElementById('confirmModal')) closeModal();
}

// ──────────────────────────────
// RENDER TABLE
// ──────────────────────────────
function renderTable() {
  const el = document.getElementById('tableContainer');
  if (!trades.length) {
    el.innerHTML = `<div class="empty-state">
      <div class="emo">📭</div>
      <p>No trades for this date.<br>Import from XLSX above or click <strong>+ Add Trade</strong>.</p>
    </div>`;
    return;
  }

  const rows = trades.map((t, i) => {
    const dirBadge = t.direction === 'Buy'
      ? `<span class="dir-badge dir-buy">▲ BUY</span>`
      : `<span class="dir-badge dir-sell">▼ SELL</span>`;

    let stBadge;
    if      (t.status === 'Win')  stBadge = `<span class="status-badge s-win"><span class="s-dot"></span>WIN</span>`;
    else if (t.status === 'Loss') stBadge = `<span class="status-badge s-loss"><span class="s-dot"></span>LOSS</span>`;
    else if (t.status === 'Tie')  stBadge = `<span class="status-badge s-tie"><span class="s-dot"></span>TIE</span>`;
    else                           stBadge = `<span class="status-badge s-pending">— Pending</span>`;

    // P&L display color
    const pnlVal = parseFloat(t.pnl);
    let pnlClass = 'pnl-zero';
    if (!isNaN(pnlVal) && pnlVal > 0) pnlClass = 'pnl-pos';
    else if (!isNaN(pnlVal) && pnlVal < 0) pnlClass = 'pnl-neg';

    const openBadge  = t.openTime  ? `<span class="time-badge has-time">${esc(t.openTime)}</span>`  : `<span class="time-badge">—</span>`;
    const closeBadge = t.closeTime ? `<span class="time-badge has-time">${esc(t.closeTime)}</span>` : `<span class="time-badge">—</span>`;

    return `<tr>
      <td class="sl-num">#${String(t.sl).padStart(2,'0')}</td>
      <td>
        ${dirBadge}
        <select onchange="updateTrade(${i},'direction',this.value)">
          <option ${t.direction==='Buy'?'selected':''}>Buy</option>
          <option ${t.direction==='Sell'?'selected':''}>Sell</option>
        </select>
      </td>
      <td>
        <input class="asset-input" type="text"
          value="${esc(t.asset||'')}"
          placeholder="e.g. AUD/CAD OTC"
          onchange="updateTrade(${i},'asset',this.value)"
          oninput="updateTrade(${i},'asset',this.value)"
          title="Enter currency pair name">
      </td>
      <td>
        ${stBadge}
        <select onchange="updateTrade(${i},'status',this.value)">
          <option value=""   ${t.status===''   ?'selected':''}>Pending</option>
          <option value="Win"  ${t.status==='Win' ?'selected':''}>Win</option>
          <option value="Loss" ${t.status==='Loss'?'selected':''}>Loss</option>
          <option value="Tie"  ${t.status==='Tie' ?'selected':''}>Tie</option>
        </select>
      </td>
      <td>
        <input class="pnl-input ${pnlClass}" type="number" step="0.01"
          value="${esc(t.pnl||'')}"
          placeholder="P&amp;L"
          onchange="updateTrade(${i},'pnl',this.value)"
          oninput="updateTrade(${i},'pnl',this.value)"
          title="Profit or Loss amount">
      </td>
      <td style="min-width:90px">${openBadge}</td>
      <td style="min-width:90px">${closeBadge}</td>
      <td><button class="del-btn" onclick="deleteTrade(${i})" title="Delete row">🗑</button></td>
    </tr>`;
  }).join('');

  el.innerHTML = `<div class="table-scroll"><table>
    <thead><tr>
      <th>SL No.</th>
      <th>Trade Direction</th>
      <th>Asset</th>
      <th>Status</th>
      <th>P&amp;L ($)</th>
      <th>Open Time</th>
      <th>Close Time</th>
      <th></th>
    </tr></thead>
    <tbody>${rows}</tbody>
  </table></div>`;
}

function esc(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ──────────────────────────────
// STATS & PIE UPDATE
// ──────────────────────────────
function updateStats() {
  const wins    = trades.filter(t => t.status === 'Win').length;
  const losses  = trades.filter(t => t.status === 'Loss').length;
  const settled = wins + losses;
  const wr      = settled > 0 ? (wins / settled) * 100 : 0;

  document.getElementById('sTot').textContent  = trades.length;
  document.getElementById('sWin').textContent  = wins;
  document.getElementById('sLoss').textContent = losses;
  document.getElementById('sRate').textContent = wr.toFixed(2) + '%';
  document.getElementById('chartRate').textContent = wr.toFixed(1) + '%';

  // ── P&L totals ──
  let pnlTotal = 0, pnlProfit = 0, pnlLoss = 0;
  trades.forEach(t => {
    const v = parseFloat(t.pnl);
    if (isNaN(v)) return;
    pnlTotal += v;
    if (v > 0) pnlProfit += v;
    else if (v < 0) pnlLoss += v;
  });
  const fmt = n => (n >= 0 ? '+' : '') + '$' + Math.abs(n).toFixed(2);
  const totEl = document.getElementById('sPnlTotal');
  totEl.textContent = fmt(pnlTotal);
  totEl.className   = 'v ' + (pnlTotal > 0 ? 'pnl-pos' : pnlTotal < 0 ? 'pnl-neg' : 'pnl-zero');
  document.getElementById('sPnlWin').textContent  = '+$' + pnlProfit.toFixed(2);
  document.getElementById('sPnlLoss').textContent = '-$' + Math.abs(pnlLoss).toFixed(2);

  // Pie chart
  if (pieInst) {
    if (settled === 0) {
      pieInst.data.datasets[0].data = [1, 1];
      pieInst.data.datasets[0].backgroundColor = ['rgba(0,229,160,.14)','rgba(255,77,109,.14)'];
    } else {
      pieInst.data.datasets[0].data = [wins, losses];
      pieInst.data.datasets[0].backgroundColor = ['#00e5a0','#ff4d6d'];
    }
    pieInst.update();
  }

  updateGoal1(wr);
  updateGoal2(wins);

  // Personal best
  const pb = parseFloat(localStorage.getItem('pb_winrate') || '0');
  if (wr > pb && settled > 0) {
    localStorage.setItem('pb_winrate', wr.toFixed(4));
    toast('🏆 New Personal Best: ' + wr.toFixed(2) + '%', 'ok');
  }

  // Refresh period (weekly/monthly) goals live
  renderPeriodGoals();
}

// ──────────────────────────────
// GOAL 1 — WIN RATE
// ──────────────────────────────
function setGoal1() {
  const v = parseFloat(document.getElementById('gi1').value);
  if (isNaN(v) || v < 0 || v > 100) { toast('Enter a number between 0–100', 'err'); return; }
  goal1 = v;
  localStorage.setItem(goalKey(currentDate), v);
  const wins    = trades.filter(t => t.status === 'Win').length;
  const settled = wins + trades.filter(t => t.status === 'Loss').length;
  const wr      = settled > 0 ? (wins / settled) * 100 : 0;
  updateGoal1(wr);
  toast('Win rate target set: ' + v + '%', 'ok');
}

function updateGoal1(wr) {
  const badgeEl = document.getElementById('gb1');
  if (goal1 === null) {
    document.getElementById('gpb1').style.width = '0%';
    document.getElementById('gCurLabel').textContent = wr.toFixed(2) + '%';
    document.getElementById('gTgtLabel').textContent = 'Target: —';
    badgeEl.innerHTML = '';
    return;
  }
  const pct = Math.min((wr / goal1) * 100, 100);
  document.getElementById('gpb1').style.width = pct + '%';
  document.getElementById('gCurLabel').textContent = wr.toFixed(2) + '%';
  document.getElementById('gTgtLabel').textContent = 'Target: ' + goal1 + '%';

  if (wr >= goal1 * 1.1) {
    badgeEl.innerHTML = '<span class="badge badge-purple">🚀 EXCEEDED</span>';
  } else if (wr >= goal1) {
    badgeEl.innerHTML = '<span class="badge badge-green">✅ ACHIEVED</span>';
  } else {
    badgeEl.innerHTML = '';
  }
}

// ──────────────────────────────
// GOAL 2 — TOTAL WINS
// ──────────────────────────────
function setGoal2() {
  const v = parseInt(document.getElementById('gi2').value);
  if (isNaN(v) || v < 1) { toast('Enter an integer ≥ 1', 'err'); return; }
  goal2 = v;
  winsGoalFired = false;
  localStorage.setItem(winsGoalKey(currentDate), v);
  const wins = trades.filter(t => t.status === 'Win').length;
  updateGoal2(wins);
  toast('Wins target set: ' + v, 'ok');
}

function updateGoal2(wins) {
  const arc    = document.getElementById('ringArc');
  const badgeEl= document.getElementById('gb2');
  document.getElementById('rNum').textContent = wins;

  if (goal2 === null) {
    arc.style.strokeDashoffset = 226.2;
    document.getElementById('rDen').textContent = '/—';
    document.getElementById('rPct').textContent = '0.0%';
    document.getElementById('rSub').textContent = 'Set a target';
    document.getElementById('gpb2').style.width = '0%';
    badgeEl.innerHTML = '';
    return;
  }

  const pct    = Math.min((wins / goal2) * 100, 100);
  const offset = 226.2 - (226.2 * pct / 100);
  arc.style.strokeDashoffset = offset;
  arc.style.stroke = wins > goal2 ? 'var(--accent3)' : 'var(--win)';

  document.getElementById('rDen').textContent = '/' + goal2;
  document.getElementById('rPct').textContent = pct.toFixed(1) + '%';
  document.getElementById('rSub').textContent = wins + ' of ' + goal2 + ' target wins';
  document.getElementById('gpb2').style.width = pct + '%';

  if (wins > goal2) {
    badgeEl.innerHTML = '<span class="badge badge-purple">🚀 EXCEEDED</span>';
  } else if (wins === goal2) {
    badgeEl.innerHTML = '<span class="badge badge-green">✅ ACHIEVED</span>';
  } else {
    badgeEl.innerHTML = '';
  }

  // Celebration — fires only once
  if (wins >= goal2 && !winsGoalFired) {
    winsGoalFired = true;
    celebrate(wins, goal2);
  }
}

function celebrate(wins, target) {
  const banner = document.getElementById('achBanner');
  banner.textContent = '🎉 Daily Wins Goal Achieved! ' + wins + '/' + target;
  banner.classList.add('show');

  const card = document.getElementById('gc2');
  card.classList.add('achieved');
  card.style.animation = 'pulseRing .8s ease';
  setTimeout(() => card.style.animation = '', 900);

  // Confetti
  const colors = ['#00e5a0','#6c63ff','#ff4d6d','#f4a261','#ffffff'];
  for (let i = 0; i < 18; i++) {
    const d = document.createElement('div');
    d.className = 'cfdot';
    d.style.background = colors[i % colors.length];
    d.style.left  = (25 + Math.random() * 50) + '%';
    d.style.top   = (25 + Math.random() * 50) + '%';
    d.style.setProperty('--tx', (Math.random() * 120 - 60) + 'px');
    d.style.setProperty('--ty', (Math.random() * 120 - 60) + 'px');
    d.style.animationDuration  = (.55 + Math.random() * .45) + 's';
    d.style.animationDelay     = (Math.random() * .2) + 's';
    card.appendChild(d);
    setTimeout(() => d.remove(), 1200);
  }
  toast('🎉 Daily Wins Goal Achieved! ' + wins + '/' + target, 'ok');
}

// ──────────────────────────────
// PIE CHART INIT
// ──────────────────────────────
function initPie() {
  const ctx = document.getElementById('pieChart').getContext('2d');
  pieInst = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Wins','Losses'],
      datasets: [{
        data: [1, 1],
        backgroundColor: ['rgba(0,229,160,.14)','rgba(255,77,109,.14)'],
        borderWidth: 0,
        hoverOffset: 4
      }]
    },
    options: {
      cutout: '72%',
      responsive: true,
      animation: { animateRotate: true, duration: 500 },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => {
              const tot = ctx.dataset.data.reduce((a,b) => a + b, 0);
              const pct = tot ? (ctx.parsed / tot * 100).toFixed(2) : 0;
              return ` ${ctx.label}: ${pct}%`;
            }
          }
        }
      }
    }
  });
}

// ──────────────────────────────
// XLSX IMPORT
// ──────────────────────────────
function setupDropZone() {
  const zone  = document.getElementById('dropZone');
  const input = document.getElementById('xlsxInput');

  zone.addEventListener('click', () => input.click());
  zone.addEventListener('dragover',  e => { e.preventDefault(); zone.classList.add('dragover'); });
  zone.addEventListener('dragleave', ()  => zone.classList.remove('dragover'));
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('dragover');
    if (e.dataTransfer.files[0]) readXlsx(e.dataTransfer.files[0]);
  });
  input.addEventListener('change', e => {
    if (e.target.files[0]) readXlsx(e.target.files[0]);
  });
}

function readXlsx(file) {
  if (!file.name.toLowerCase().endsWith('.xlsx')) {
    toast('Only .xlsx files are accepted', 'err'); return;
  }

  // Show filename
  document.getElementById('impFilenameText').textContent = file.name;
  document.getElementById('impFilename').style.display   = 'flex';
  document.getElementById('impProcessing').style.display = 'flex';
  document.getElementById('impStats').style.display      = 'none';
  document.getElementById('impActions').style.display    = 'none';
  document.getElementById('btnDlXlsx').style.display     = 'none';

  const reader = new FileReader();
  reader.onload = e => {
    setTimeout(() => {
      try {
        const wb  = XLSX.read(e.target.result, { type: 'array' });
        const ws  = wb.Sheets[wb.SheetNames[0]];
        const raw = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
        processXlsx(raw);
      } catch(err) {
        document.getElementById('impProcessing').style.display = 'none';
        toast('Error reading file: ' + err.message, 'err');
      }
    }, 600);
  };
  reader.readAsArrayBuffer(file);
}

function processXlsx(raw) {
  // ── Find real header row ──
  let hdrIdx = -1;
  for (let i = 0; i < raw.length; i++) {
    const rowStr = raw[i].map(c => String(c).toLowerCase()).join(',');
    if (rowStr.includes('direction') || rowStr.includes('asset')) {
      hdrIdx = i; break;
    }
  }
  if (hdrIdx === -1) hdrIdx = 0;

  const hdrs       = raw[hdrIdx].map(h => String(h).toLowerCase().trim());
  const iDir       = hdrs.findIndex(h => h.includes('direction'));
  const iAsset     = hdrs.findIndex(h => h.includes('asset'));
  const iProfit    = hdrs.findIndex(h => h.includes('profit'));
  const iAmount    = hdrs.findIndex(h => h.includes('amount') || h.includes('trade amount') || h.includes('stake'));
  // Open time column — used for date AND open time extraction
  const iOpenTime  = hdrs.findIndex(h => h === 'open time' || h === 'opentime' || (h.includes('open') && h.includes('time')));
  // Close time column — separate column for close timestamp
  const iCloseTime = hdrs.findIndex(h => h === 'close time' || h === 'closetime' || (h.includes('close') && h.includes('time')));
  // Date column — prefer Open time, then any date column
  const iDate      = iOpenTime >= 0
    ? iOpenTime
    : hdrs.findIndex(h => h.includes('date') || h.includes('time'));

  parsedImport = [];
  isMultiDate  = false;
  const detectedDates = new Set();
  let cW = 0, cL = 0, cT = 0;

  for (let i = hdrIdx + 1; i < raw.length; i++) {
    const row = raw[i];
    if (!row || row.every(c => c === '' || c === null || c === undefined)) continue;

    const dirRaw  = String(row[iDir]    || '').toLowerCase().trim();
    const asset   = String(row[iAsset]  || '').trim();
    const profit  = parseFloat(row[iProfit]);
    const amount  = iAmount >= 0 ? parseFloat(row[iAmount]) : NaN;

    if (!dirRaw && !asset) continue;

    // Direction mapping
    let direction;
    if      (dirRaw === 'put'  || dirRaw === 'sell') direction = 'Sell';
    else if (dirRaw === 'call' || dirRaw === 'buy')  direction = 'Buy';
    else direction = dirRaw.charAt(0).toUpperCase() + dirRaw.slice(1) || 'Buy';

    // Status from profit
    const profitVal = isNaN(profit) ? 0 : profit;
    let status;
    if      (profitVal > 0) { status = 'Win';  cW++; }
    else if (profitVal < 0) { status = 'Loss'; cL++; }
    else                    { status = 'Tie';  cT++; }

    // P&L: use profit column directly if available, else compute from amount
    let pnl = '';
    if (!isNaN(profit)) {
      pnl = profit.toFixed(2);
    } else if (!isNaN(amount)) {
      pnl = (status === 'Win' ? amount : status === 'Loss' ? -amount : 0).toFixed(2);
    }

    // Date + time parsing
    let tradeDate = currentDate;
    let openTime  = '';
    let closeTime = '';

    if (iDate >= 0 && row[iDate] !== '' && row[iDate] !== null && row[iDate] !== undefined) {
      const rawDate = row[iDate];
      const parsed  = parseExcelDate(rawDate);
      if (parsed) { tradeDate = parsed; detectedDates.add(parsed); }
      openTime = extractTime12h(rawDate);
    }
    if (iCloseTime >= 0 && row[iCloseTime] !== '' && row[iCloseTime] !== null && row[iCloseTime] !== undefined) {
      closeTime = extractTime12h(row[iCloseTime]);
    }

    parsedImport.push({ direction, asset, status, pnl, date: tradeDate, openTime, closeTime });
  }

  document.getElementById('impProcessing').style.display = 'none';

  if (!parsedImport.length) {
    toast('No valid trade rows found in file', 'err');
    return;
  }

  // ── Duplicate detection ──
  // Build a set of fingerprints from ALL existing localStorage dates
  const existingFingerprints = buildExistingFingerprints();
  let dupCount = 0;
  parsedImport = parsedImport.filter(t => {
    const fp = tradeFingerprint(t);
    if (existingFingerprints.has(fp)) { dupCount++; return false; }
    return true;
  });

  isMultiDate = detectedDates.size > 1 ||
    (detectedDates.size === 1 && !detectedDates.has(currentDate));

  // ── Update UI ──
  document.getElementById('impW').textContent = cW;
  document.getElementById('impL').textContent = cL;
  document.getElementById('impT').textContent = cT;
  document.getElementById('impStats').style.display = 'grid';

  // Meta row
  const metaRow = document.getElementById('impMetaRow');
  metaRow.style.display = 'flex';
  document.getElementById('impDateCount').textContent = isMultiDate ? detectedDates.size : 1;
  document.getElementById('impDupCount').textContent  = dupCount;
  document.getElementById('impNewCount').textContent  = parsedImport.length;

  // Multi-date preview table
  if (isMultiDate) {
    renderMultiDateSummary();
  } else {
    document.getElementById('multidateSummary').style.display = 'none';
  }

  document.getElementById('impActions').style.display = 'flex';
  document.getElementById('btnDlXlsx').style.display  = 'flex';
  document.getElementById('xlsxMemNote').style.display = 'flex';

  const dupMsg = dupCount > 0 ? ` (${dupCount} duplicate${dupCount>1?'s':''} skipped)` : '';
  toast(`Parsed ${parsedImport.length} new trades${dupMsg} — review & confirm`, 'ok');
}

// Parse various date formats from Excel cells, including "YYYY-MM-DD HH:MM:SS" (Open time column)
function parseExcelDate(raw) {
  if (!raw && raw !== 0) return null;

  // Excel numeric serial date (date-only numbers)
  if (typeof raw === 'number') {
    const d = new Date(Math.round((raw - 25569) * 86400 * 1000));
    if (!isNaN(d)) return d.toISOString().slice(0, 10);
  }

  const s = String(raw).trim();

  // ── PRIMARY: "YYYY-MM-DD HH:MM:SS" — the "Open time" column format ──
  // Matches e.g. "2026-02-22 06:37:40"  or  "2026-02-22T06:37:40"
  const dtMatch = s.match(/^(\d{4})-(\d{2})-(\d{2})[\sT]\d{2}:\d{2}/);
  if (dtMatch) return `${dtMatch[1]}-${dtMatch[2]}-${dtMatch[3]}`;

  // ── Pure date patterns ──
  const patterns = [
    { re: /^(\d{4})-(\d{2})-(\d{2})$/,          ymd: [1,2,3] },  // YYYY-MM-DD
    { re: /^(\d{2})\/(\d{2})\/(\d{4})$/,         ymd: [3,2,1] },  // DD/MM/YYYY
    { re: /^(\d{2})-(\d{2})-(\d{4})$/,           ymd: [3,2,1] },  // DD-MM-YYYY
    { re: /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/,     ymd: [3,2,1] },  // D/M/YYYY
  ];
  for (const { re, ymd } of patterns) {
    const m = s.match(re);
    if (m) {
      const [y, mo, d] = [m[ymd[0]], m[ymd[1]], m[ymd[2]]];
      const dt = new Date(`${y}-${mo.padStart(2,'0')}-${d.padStart(2,'0')}T12:00:00`);
      if (!isNaN(dt)) return dt.toISOString().slice(0, 10);
    }
  }

  // Fallback: native Date parse (strips time automatically via toISOString)
  const dt = new Date(s);
  if (!isNaN(dt)) return dt.toISOString().slice(0, 10);
  return null;
}

// Build fingerprint strings for ALL existing trades (active account only)
function buildExistingFingerprints() {
  const fps = new Set();
  const pfx = tradesPrefix();
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (!key || !key.startsWith(pfx)) continue;
    try {
      const arr = JSON.parse(localStorage.getItem(key)) || [];
      arr.forEach(t => fps.add(tradeFingerprint({ ...t, date: key.slice(pfx.length) })));
    } catch(e) {}
  }
  return fps;
}

// Fingerprint: direction + asset (lowercased, trimmed) + status + date
function tradeFingerprint(t) {
  return [
    (t.direction||'').toLowerCase().trim(),
    (t.asset||'').toLowerCase().trim(),
    (t.status||'').toLowerCase().trim(),
    (t.date||'').trim()
  ].join('|');
}

function renderMultiDateSummary() {
  // Group parsedImport by date
  const byDate = {};
  parsedImport.forEach(t => {
    if (!byDate[t.date]) byDate[t.date] = { w:0, l:0, ti:0, count:0 };
    byDate[t.date].count++;
    if (t.status==='Win')  byDate[t.date].w++;
    if (t.status==='Loss') byDate[t.date].l++;
    if (t.status==='Tie')  byDate[t.date].ti++;
  });
  const dates = Object.keys(byDate).sort();
  const box   = document.getElementById('multidateSummary');
  box.style.display = 'block';
  document.getElementById('mdsTotal').textContent = parsedImport.length + ' trades';
  document.getElementById('mdsRows').innerHTML = dates.map(d =>
    `<div class="mds-row">
      <span class="mds-row-date">${fmtDateDMY(d)}</span>
      <span style="color:var(--muted);font-size:.7rem">${byDate[d].count} trade${byDate[d].count!==1?'s':''}</span>
      <span class="mds-row-wins">W: ${byDate[d].w}</span>
      <span class="mds-row-loss">L: ${byDate[d].l}</span>
      <span class="mds-row-tie">T: ${byDate[d].ti}</span>
    </div>`
  ).join('');
}

function confirmImport() {
  if (!parsedImport.length) return;

  // Compute P&L of the new trades being imported (to add to balance)
  let importPnl = 0;
  parsedImport.forEach(t => { const v = parseFloat(t.pnl); if (!isNaN(v)) importPnl += v; });

  if (isMultiDate) {
    // Group by date and merge into each date's localStorage bucket
    const byDate = {};
    parsedImport.forEach(t => {
      if (!byDate[t.date]) byDate[t.date] = [];
      byDate[t.date].push(t);
    });

    let totalInserted = 0;
    Object.keys(byDate).forEach(date => {
      const key      = tradesKey(date);
      const existing = JSON.parse(localStorage.getItem(key) || '[]');
      const offset   = existing.length;
      byDate[date].forEach((t, i) => {
        existing.push({ sl: offset+i+1, direction:t.direction, status:t.status, asset:t.asset, pnl:t.pnl||'', openTime:t.openTime||'', closeTime:t.closeTime||'' });
      });
      localStorage.setItem(key, JSON.stringify(existing));
      totalInserted += byDate[date].length;
      if (date === currentDate) trades = existing;
    });

    renderTable();
    updateStats();
    toast(`✓ ${totalInserted} trades saved across ${Object.keys(byDate).length} date(s)`, 'ok');

  } else {
    // Single-date mode: insert into current trades
    const offset = trades.length;
    parsedImport.forEach((t, i) => {
      trades.push({ sl: offset+i+1, direction:t.direction, status:t.status, asset:t.asset, pnl:t.pnl||'', openTime:t.openTime||'', closeTime:t.closeTime||'' });
    });
    saveData();
    renderTable();
    updateStats();
    toast(`✓ ${parsedImport.length} trades inserted into table`, 'ok');
  }

  // Auto-update Main Balance with imported P&L
  if (importPnl !== 0) {
    const key = getBalanceKey();
    const cur = parseFloat(localStorage.getItem(key) || '0');
    const updated = cur + importPnl;
    localStorage.setItem(key, updated.toFixed(2));
    renderBalanceDisplay();
    toast(`💰 Balance updated by ${importPnl >= 0 ? '+' : ''}$${importPnl.toFixed(2)}`, 'ok');
  }

  document.getElementById('impActions').style.display       = 'none';
  document.getElementById('impStats').style.display         = 'none';
  document.getElementById('impMetaRow').style.display       = 'none';
  document.getElementById('multidateSummary').style.display = 'none';
  document.getElementById('btnDlXlsx').style.display        = 'none';
  document.getElementById('xlsxMemNote').style.display      = 'none';
}

function cancelImport() {
  parsedImport = [];
  isMultiDate  = false;
  document.getElementById('impFilename').style.display      = 'none';
  document.getElementById('impStats').style.display         = 'none';
  document.getElementById('impActions').style.display       = 'none';
  document.getElementById('btnDlXlsx').style.display        = 'none';
  document.getElementById('xlsxMemNote').style.display      = 'none';
  document.getElementById('impMetaRow').style.display       = 'none';
  document.getElementById('multidateSummary').style.display = 'none';
  document.getElementById('xlsxInput').value                = '';
  toast('Import cancelled', 'err');
}

// Clears the temporary parsedImport array from JS memory without saving
function clearPendingImport() {
  parsedImport = [];
  isMultiDate  = false;
  document.getElementById('impFilename').style.display      = 'none';
  document.getElementById('impStats').style.display         = 'none';
  document.getElementById('impActions').style.display       = 'none';
  document.getElementById('btnDlXlsx').style.display        = 'none';
  document.getElementById('xlsxMemNote').style.display      = 'none';
  document.getElementById('impMetaRow').style.display       = 'none';
  document.getElementById('multidateSummary').style.display = 'none';
  document.getElementById('xlsxInput').value                = '';
  toast('🗑 Pending import cleared from memory', 'ok');
}

function downloadXlsx() {
  const src = parsedImport.length ? parsedImport : trades.map(t => ({
    direction: t.direction, asset: t.asset || '', status: t.status || 'Pending',
    pnl: t.pnl || '', openTime: t.openTime || '', closeTime: t.closeTime || ''
  }));
  if (!src.length) { toast('No data to download', 'err'); return; }

  const wsData = [
    ['SL No.', 'Trade Direction', 'Asset', 'Status', 'P&L', 'Open Time', 'Close Time'],
    ...src.map((r, i) => [i+1, r.direction, r.asset, r.status, r.pnl, r.openTime||'', r.closeTime||''])
  ];
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  ws['!cols'] = [{ wch:8 },{ wch:18 },{ wch:20 },{ wch:10 },{ wch:10 },{ wch:16 },{ wch:16 }];
  XLSX.utils.book_append_sheet(wb, ws, 'Trade_History');
  const acctTag = activeAccount === 'demo' ? '_Demo' : '_Live';
  XLSX.writeFile(wb, 'Trade_History_Formatted' + acctTag + '.xlsx');
  toast('✓ Formatted XLSX downloaded (' + src.length + ' rows)', 'ok');
}

// ──────────────────────────────
// ANALYTICS
// ──────────────────────────────
function updateAnalytics() {
  const period = document.getElementById('periodSel').value;
  const from   = document.getElementById('aFrom').value;
  const to     = document.getElementById('aTo').value;
  if (!from || !to) return;

  // Build all dates in range
  const allDates = [];
  const cur = new Date(from + 'T12:00:00');
  const end = new Date(to   + 'T12:00:00');
  while (cur <= end) {
    allDates.push(cur.toISOString().slice(0, 10));
    cur.setDate(cur.getDate() + 1);
  }

  // Per-date stats
  const ds = {};
  allDates.forEach(d => {
    const raw = localStorage.getItem(tradesKey(d));
    if (!raw) return;
    const ts = JSON.parse(raw);
    const w  = ts.filter(t => t.status === 'Win').length;
    const l  = ts.filter(t => t.status === 'Loss').length;
    const s  = w + l;
    if (s > 0) ds[d] = { wins: w, losses: l, settled: s, wr: w / s * 100 };
  });

  const dates       = Object.keys(ds).sort();
  const totSettled  = dates.reduce((a, d) => a + ds[d].settled, 0);
  const totWins     = dates.reduce((a, d) => a + ds[d].wins, 0);
  const overallWR   = totSettled > 0 ? (totWins / totSettled * 100) : 0;

  document.getElementById('aKpi1').textContent = overallWR.toFixed(2) + '%';
  document.getElementById('aKpi2').textContent = totSettled;

  if (dates.length) {
    const best  = dates.reduce((a, b) => ds[a].wr >= ds[b].wr ? a : b);
    const worst = dates.reduce((a, b) => ds[a].wr <= ds[b].wr ? a : b);
    document.getElementById('aKpi3').textContent    = fDate(best);
    document.getElementById('aKpi3sub').textContent = ds[best].wr.toFixed(2) + '% win rate';
    document.getElementById('aKpi4').textContent    = fDate(worst);
    document.getElementById('aKpi4sub').textContent = ds[worst].wr.toFixed(2) + '% win rate';
  } else {
    ['aKpi3','aKpi4'].forEach(id => document.getElementById(id).textContent = '—');
    ['aKpi3sub','aKpi4sub'].forEach(id => document.getElementById(id).textContent = 'No data');
  }

  // WoW
  const now  = new Date(); now.setHours(12,0,0,0);
  const d7   = new Date(now); d7.setDate(d7.getDate() - 7);
  const d14  = new Date(now); d14.setDate(d14.getDate() - 14);
  const last = dates.filter(d => new Date(d+'T12:00:00') >  d7);
  const prev = dates.filter(d => { const dt = new Date(d+'T12:00:00'); return dt > d14 && dt <= d7; });
  const wrL  = calcWR(last, ds);
  const wrP  = calcWR(prev, ds);
  const diff = wrL - wrP;
  const sub1 = document.getElementById('aKpi1sub');
  if (prev.length) {
    sub1.textContent = (diff >= 0 ? '↑ ' : '↓ ') + Math.abs(diff).toFixed(1) + '% vs prev week';
    sub1.className   = 'kpi-sub ' + (diff >= 0 ? 'up' : 'down');
  } else {
    sub1.textContent = 'No comparison data';
    sub1.className   = 'kpi-sub';
  }
  document.getElementById('aKpi2sub').textContent = dates.length + ' active trading days';

  buildAnalyticsCharts(period, dates, ds);

  // ── Extra analytics ──
  const allTradesInRange = [];
  allDates.forEach(d => {
    const raw = localStorage.getItem(tradesKey(d));
    if (raw) JSON.parse(raw).forEach(t => allTradesInRange.push({ ...t, date: d }));
  });
  renderDOWChart(allTradesInRange);
  renderHourChart(allTradesInRange);
  renderHeatmap();
}

function calcWR(arr, ds) {
  const w = arr.reduce((a, d) => a + (ds[d]?.wins    || 0), 0);
  const s = arr.reduce((a, d) => a + (ds[d]?.settled || 0), 0);
  return s > 0 ? w / s * 100 : 0;
}

function fDate(d) {
  return new Date(d + 'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
}

function isoWeek(dt) {
  const d = new Date(Date.UTC(dt.getFullYear(), dt.getMonth(), dt.getDate()));
  const day = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - day);
  const yr = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  return Math.ceil((((d - yr) / 86400000) + 1) / 7);
}

function buildAnalyticsCharts(period, dates, ds) {
  // Group by period
  const groups = {};
  dates.forEach(d => {
    const dt = new Date(d + 'T12:00:00');
    let key;
    if      (period === 'daily')   key = d;
    else if (period === 'weekly')  key = dt.getFullYear() + '-W' + String(isoWeek(dt)).padStart(2,'0');
    else                           key = d.slice(0, 7);
    if (!groups[key]) groups[key] = { wins: 0, settled: 0 };
    groups[key].wins    += ds[d].wins;
    groups[key].settled += ds[d].settled;
  });

  const labels  = Object.keys(groups).sort();
  const wrData  = labels.map(k => groups[k].settled ? (groups[k].wins / groups[k].settled * 100).toFixed(2) : 0);
  const volData = labels.map(k => groups[k].settled);
  const shortL  = labels.map(k => k.length > 10 ? k.slice(5) : k);

  if (trendInst) { trendInst.destroy(); trendInst = null; }
  if (volInst)   { volInst.destroy();   volInst   = null; }

  const baseFont   = { family: 'DM Mono', size: 10 };
  const gridColor  = 'rgba(255,255,255,0.05)';
  const tickColor  = '#6b6b8a';

  trendInst = new Chart(document.getElementById('trendChart').getContext('2d'), {
    type: 'line',
    data: {
      labels: shortL,
      datasets: [{
        label: 'Win Rate %',
        data: wrData,
        borderColor: '#00e5a0',
        backgroundColor: 'rgba(0,229,160,.08)',
        fill: true, tension: .4,
        pointRadius: 3, pointBackgroundColor: '#00e5a0', borderWidth: 2
      }]
    },
    options: {
      responsive: true, animation: { duration: 400 },
      scales: {
        x: { ticks: { font: baseFont, color: tickColor }, grid: { color: gridColor } },
        y: { min: 0, max: 100, ticks: { font: baseFont, color: tickColor }, grid: { color: gridColor } }
      },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: c => ` Win Rate: ${c.parsed.y}%` } }
      }
    }
  });

  volInst = new Chart(document.getElementById('volChart').getContext('2d'), {
    type: 'bar',
    data: {
      labels: shortL,
      datasets: [{
        label: 'Trades',
        data: volData,
        backgroundColor: 'rgba(108,99,255,.6)',
        borderColor: '#6c63ff',
        borderWidth: 1, borderRadius: 5
      }]
    },
    options: {
      responsive: true, animation: { duration: 400 },
      scales: {
        x: { ticks: { font: baseFont, color: tickColor }, grid: { color: gridColor } },
        y: { beginAtZero: true, ticks: { font: baseFont, color: tickColor }, grid: { color: gridColor } }
      },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: c => ` Trades: ${c.parsed.y}` } }
      }
    }
  });
}

// ──────────────────────────────
// EXPORT RANGE MODAL
// ──────────────────────────────
function openExportModal(type) {
  exportType = type || 'csv';
  // Default range: current date only
  document.getElementById('expFrom').value = currentDate;
  document.getElementById('expTo').value   = currentDate;
  setExportType(exportType);
  document.getElementById('exportModal').classList.add('open');
}
function closeExportModal() {
  document.getElementById('exportModal').classList.remove('open');
}
function exportModalOverlayClick(e) {
  if (e.target === document.getElementById('exportModal')) closeExportModal();
}
function setExportType(t) {
  exportType = t;
  document.getElementById('expTabCSV').classList.toggle('active', t === 'csv');
  document.getElementById('expTabPDF').classList.toggle('active', t === 'pdf');
}
function runExport() {
  const from = document.getElementById('expFrom').value;
  const to   = document.getElementById('expTo').value;
  if (!from || !to) { toast('Please select a date range', 'err'); return; }
  if (from > to) { toast('From date must be before To date', 'err'); return; }
  closeExportModal();
  if (exportType === 'csv') exportCSVRange(from, to);
  else exportPDFRange(from, to);
}

// ──────────────────────────────
// EXPORT — CSV (range)
// ──────────────────────────────
function fmtDateDMY(isoDate) {
  // Converts YYYY-MM-DD → DD-MM-YYYY
  if (!isoDate) return '';
  const [y, m, d] = isoDate.split('-');
  return `${d}-${m}-${y}`;
}

function exportCSV() { openExportModal('csv'); }

function exportCSVRange(from, to) {
  // Collect all trades in range
  const allTrades = [];
  const cur = new Date(from + 'T12:00:00');
  const end = new Date(to   + 'T12:00:00');
  while (cur <= end) {
    const d   = cur.toISOString().slice(0,10);
    const raw = localStorage.getItem(tradesKey(d));
    if (raw) {
      JSON.parse(raw).forEach(t => allTrades.push({ ...t, date: d }));
    }
    cur.setDate(cur.getDate() + 1);
  }
  if (!allTrades.length) { toast('No trades found in selected range', 'err'); return; }

  const wins    = allTrades.filter(t => t.status === 'Win').length;
  const losses  = allTrades.filter(t => t.status === 'Loss').length;
  const settled = wins + losses;
  const wr      = settled > 0 ? (wins / settled * 100).toFixed(2) : '0.00';
  let totalPnl  = 0;
  allTrades.forEach(t => { const v = parseFloat(t.pnl); if (!isNaN(v)) totalPnl += v; });

  let csv = '"SL No.","Trade Direction","Asset","Status","P&L","Date"\n';
  allTrades.forEach((t, i) => {
    csv += `"${i+1}","${t.direction}","${t.asset||''}","${t.status||'Pending'}","${t.pnl||''}","${fmtDateDMY(t.date)}"\n`;
  });
  const rangeLabel = from === to ? fmtDateDMY(from) : fmtDateDMY(from) + '_to_' + fmtDateDMY(to);
  csv += `\n"Total Trades","${allTrades.length}"\n"Wins","${wins}"\n"Losses","${losses}"\n"Win Rate","${wr}%"\n"Total P&L","${totalPnl>=0?'+':''}${totalPnl.toFixed(2)}"\n`;

  const a = document.createElement('a');
  a.href     = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
  a.download = (activeAccount === 'demo' ? 'demo_' : '') + 'trades_' + rangeLabel + '.csv';
  a.click();
  toast('CSV exported!', 'ok');
}

// ──────────────────────────────
// EXPORT — PDF (range)
// ──────────────────────────────
function exportPDF() { openExportModal('pdf'); }

function exportPDFRange(from, to) {
  // Collect all trades in range
  const allTrades = [];
  const cur2 = new Date(from + 'T12:00:00');
  const end2 = new Date(to   + 'T12:00:00');
  while (cur2 <= end2) {
    const d   = cur2.toISOString().slice(0,10);
    const raw = localStorage.getItem(tradesKey(d));
    if (raw) JSON.parse(raw).forEach(t => allTrades.push({ ...t, date: d }));
    cur2.setDate(cur2.getDate() + 1);
  }
  if (!allTrades.length) { toast('No trades found in selected range', 'err'); return; }
  toast('Generating PDF...', 'ok');

  const { jsPDF } = window.jspdf;
  const pdf    = new jsPDF('p', 'mm', 'a4');
  const W      = 210;
  const margin = 14;
  let y        = 0;

  // FIX 2: Build date label using plain ASCII only — no arrow/unicode chars
  const rangeLabel = from === to
    ? fmtDateDMY(from)
    : 'From ' + fmtDateDMY(from) + '  To  ' + fmtDateDMY(to);

  // ── Helper: new page with white background ──
  function newPage() {
    pdf.addPage();
    pdf.setFillColor(255, 255, 255);
    pdf.rect(0, 0, W, 297, 'F');
  }

  // ── Helper: draw Trade Log table header ──
  const colX = [margin + 3, margin + 16, margin + 44, margin + 98, margin + 134, margin + 158];
  function drawTradeLogHeader(yPos) {
    pdf.setFillColor(0, 180, 120);
    pdf.rect(margin, yPos, W - 2 * margin, 8, 'F');
    pdf.setFontSize(7.5); pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(255, 255, 255);
    ['SL', 'Date', 'Direction', 'Asset', 'Status', 'P&L']
      .forEach((h, i) => pdf.text(h, colX[i], yPos + 5.5));
    return yPos + 10;
  }

  // ── Helper: draw Currency Pair table header ──
  const pCols = [margin+3, margin+60, margin+95, margin+120, margin+145, margin+165];
  function drawPairHeader(yPos) {
    pdf.setFillColor(0, 180, 120);
    pdf.rect(margin, yPos, W - 2 * margin, 8, 'F');
    pdf.setFontSize(7); pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(255, 255, 255);
    ['Pair', 'Trades', 'Wins', 'Losses', 'Ties', 'Win Rate']
      .forEach((h, i) => pdf.text(h, pCols[i], yPos + 5.5));
    return yPos + 10;
  }

  // ── White page background (page 1) ──
  pdf.setFillColor(255, 255, 255);
  pdf.rect(0, 0, W, 297, 'F');

  // ── Header bar (green) ──
  pdf.setFillColor(0, 180, 120);
  pdf.rect(0, 0, W, 20, 'F');
  pdf.setFont('helvetica', 'bold');
  pdf.setFontSize(12);
  pdf.setTextColor(255, 255, 255);
  pdf.text('TradeEdge - Performance Report', margin, 13);
  // FIX 2: plain ASCII label, small font so it always fits on one line
  pdf.setFontSize(7.5);
  pdf.setTextColor(220, 255, 240);
  pdf.text(rangeLabel, W - margin, 13, { align: 'right' });
  y = 28;

  // ── Pie chart (only for single day) ──
  if (from === to && from === currentDate) {
    try {
      const img = document.getElementById('pieChart').toDataURL('image/png');
      pdf.addImage(img, 'PNG', (W - 58) / 2, y, 58, 58);
      y += 64;
    } catch(e) { y += 4; }
  } else { y += 4; }

  // ── Win/Loss stats ──
  const wins    = allTrades.filter(t => t.status === 'Win').length;
  const losses  = allTrades.filter(t => t.status === 'Loss').length;
  const settled = wins + losses;
  const wr      = settled > 0 ? (wins / settled * 100).toFixed(2) : '0.00';
  const lr      = settled > 0 ? (losses / settled * 100).toFixed(2) : '0.00';
  let totalPnl = 0;
  allTrades.forEach(t => { const v = parseFloat(t.pnl); if (!isNaN(v)) totalPnl += v; });

  pdf.setFontSize(10); pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(0, 150, 100);
  pdf.text('Win Rate: ' + wr + '%', W / 2 - 4, y, { align: 'right' });
  pdf.setTextColor(210, 50, 80);
  pdf.text('Loss Rate: ' + lr + '%', W / 2 + 4, y, { align: 'left' });
  y += 12;

  // ── Stats row ──
  const stats = [
    ['Total Trades', allTrades.length],
    ['Total Wins', wins],
    ['Total Losses', losses],
    ['Win Rate', wr + '%'],
    ['Total P&L', (totalPnl >= 0 ? '+' : '') + '$' + Math.abs(totalPnl).toFixed(2)]
  ];
  const cardW = (W - 2 * margin - 12) / 5;
  const cardH = 18;
  const statColors = [[60,60,80],[0,150,100],[210,50,80],[60,60,80],[totalPnl>=0?0:210,totalPnl>=0?150:50,totalPnl>=0?100:80]];
  stats.forEach((s, i) => {
    const x = margin + i * (cardW + 3);
    pdf.setFillColor(245, 246, 250);
    pdf.roundedRect(x, y, cardW, cardH, 2, 2, 'F');
    pdf.setDrawColor(220, 220, 235);
    pdf.roundedRect(x, y, cardW, cardH, 2, 2, 'S');
    pdf.setFont('helvetica', 'bold'); pdf.setFontSize(10);
    pdf.setTextColor(...statColors[i]);
    pdf.text(String(s[1]), x + cardW / 2, y + 8, { align: 'center' });
    pdf.setFont('helvetica', 'normal'); pdf.setFontSize(6.5);
    pdf.setTextColor(120, 120, 150);
    pdf.text(s[0], x + cardW / 2, y + 14, { align: 'center' });
  });
  y += cardH + 10;

  // ── Section divider ──
  pdf.setDrawColor(220, 220, 235);
  pdf.line(margin, y, W - margin, y);
  y += 7;

  // ── Trade Log heading ──
  pdf.setFontSize(10); pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(30, 30, 50);
  pdf.text('Trade Log', margin, y); y += 7;

  // ── Trade Log table header (first time) ──
  y = drawTradeLogHeader(y);

  // ── Trade Rows ──
  // FIX 1: re-draw Trade Log header on every new page
  allTrades.forEach((t, i) => {
    if (y > 270) {
      newPage();
      y = 14;
      // Repeat "Trade Log (continued)" label + header on new page
      pdf.setFontSize(8); pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(30, 30, 50);
      pdf.text('Trade Log (continued)', margin, y); y += 5;
      y = drawTradeLogHeader(y);
    }
    pdf.setFillColor(i % 2 === 0 ? 250 : 244, i % 2 === 0 ? 250 : 246, i % 2 === 0 ? 254 : 252);
    pdf.rect(margin, y, W - 2 * margin, 7, 'F');

    pdf.setFontSize(7); pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(150, 150, 170);
    pdf.text('#' + String(i+1).padStart(2,'0'), colX[0], y + 5);

    pdf.setTextColor(80, 80, 110);
    pdf.text(fmtDateDMY(t.date), colX[1], y + 5);

    pdf.setTextColor(t.direction==='Buy' ? 80:200, t.direction==='Buy'?80:100, t.direction==='Buy'?200:80);
    pdf.text(t.direction, colX[2], y + 5);

    pdf.setTextColor(40, 40, 60);
    pdf.text((t.asset || '-').slice(0, 20), colX[3], y + 5);

    if      (t.status === 'Win')  { pdf.setTextColor(0, 150, 100); }
    else if (t.status === 'Loss') { pdf.setTextColor(210, 50, 80); }
    else if (t.status === 'Tie')  { pdf.setTextColor(200, 120, 30); }
    else                           { pdf.setTextColor(150, 150, 170); }
    pdf.text(t.status || 'Pending', colX[4], y + 5);

    const pv = parseFloat(t.pnl);
    if (!isNaN(pv)) {
      pdf.setTextColor(pv >= 0 ? 0 : 210, pv >= 0 ? 150 : 50, pv >= 0 ? 100 : 80);
      pdf.text((pv >= 0 ? '+' : '') + '$' + Math.abs(pv).toFixed(2), colX[5], y + 5);
    } else { pdf.setTextColor(150,150,170); pdf.text('-', colX[5], y + 5); }
    y += 7;
  });

  // ── Currency Pair Summary ──
  // Ensure enough room for section heading + table header before starting
  if (y > 240) { newPage(); y = 14; }
  y += 6;
  pdf.setDrawColor(220, 220, 235);
  pdf.line(margin, y, W - margin, y); y += 7;
  pdf.setFontSize(10); pdf.setFont('helvetica','bold'); pdf.setTextColor(30,30,50);
  pdf.text('Currency Pair Summary', margin, y); y += 8;

  const pStats = buildPairStats(allTrades);
  const pSorted = Object.keys(pStats).sort((a,b) => pStats[b].wr - pStats[a].wr);

  if (pSorted.length) {
    // FIX 3: draw pair header (first time)
    y = drawPairHeader(y);

    pSorted.forEach((p, i) => {
      if (y > 275) {
        newPage();
        y = 14;
        // FIX 3: repeat "Currency Pair Summary (continued)" + header on new page
        pdf.setFontSize(8); pdf.setFont('helvetica', 'bold');
        pdf.setTextColor(30, 30, 50);
        pdf.text('Currency Pair Summary (continued)', margin, y); y += 5;
        y = drawPairHeader(y);
      }
      pdf.setFillColor(i%2===0?250:244, i%2===0?250:246, i%2===0?254:252);
      pdf.rect(margin, y, W-2*margin, 7, 'F');
      const ps = pStats[p];
      const wrColor = ps.wr>=60?[0,150,100]:ps.wr>=40?[180,120,0]:[210,50,80];
      pdf.setFontSize(7.5); pdf.setFont('helvetica','normal');
      pdf.setTextColor(30,30,50);   pdf.text(p.slice(0,24), pCols[0], y+5);
      pdf.setTextColor(80,80,110);  pdf.text(String(ps.total),   pCols[1], y+5);
      pdf.setTextColor(0,150,100);  pdf.text(String(ps.wins),    pCols[2], y+5);
      pdf.setTextColor(210,50,80);  pdf.text(String(ps.losses),  pCols[3], y+5);
      pdf.setTextColor(200,120,30); pdf.text(String(ps.ties),    pCols[4], y+5);
      pdf.setTextColor(...wrColor); pdf.text(ps.wr.toFixed(1)+'%', pCols[5], y+5);
      y += 7;
    });
  } else {
    pdf.setFontSize(8); pdf.setFont('helvetica','normal'); pdf.setTextColor(150,150,170);
    pdf.text('No currency pair data available.', margin, y); y += 8;
  }

  // ── Footer ──
  pdf.setFontSize(7.5); pdf.setTextColor(180,180,200); pdf.setFont('helvetica','normal');
  pdf.text('Generated by TradeEdge - ' + new Date().toLocaleString(), margin, 291);
  pdf.setDrawColor(220,220,235); pdf.line(margin, 287, W-margin, 287);

  const fnLabel = from === to ? fmtDateDMY(from) : fmtDateDMY(from) + '_to_' + fmtDateDMY(to);
  pdf.save('TradeEdge_' + fnLabel + '.pdf');
  setTimeout(() => toast('PDF exported!', 'ok'), 400);
}

// ──────────────────────────────
// CURRENCY PAIRS ANALYSIS
// ──────────────────────────────
let pairPieInst   = null;
let pairTrendInst = null;

function getAllTradesFromStorage(fromDate, toDate) {
  const all = [];
  const cur = new Date(fromDate + 'T12:00:00');
  const end = new Date(toDate   + 'T12:00:00');
  while (cur <= end) {
    const d   = cur.toISOString().slice(0,10);
    const raw = localStorage.getItem(tradesKey(d));
    if (raw) {
      JSON.parse(raw).forEach(t => { if (t.asset) all.push({ ...t, date: d }); });
    }
    cur.setDate(cur.getDate() + 1);
  }
  return all;
}

function buildPairStats(tradeList) {
  // Returns { pairName: { wins, losses, ties, total, wr, dates:{date:{w,l,t}} } }
  const stats = {};
  tradeList.forEach(t => {
    const p = (t.asset || '').trim();
    if (!p) return;
    if (!stats[p]) stats[p] = { wins:0, losses:0, ties:0, total:0, dates:{} };
    stats[p].total++;
    if (!stats[p].dates[t.date]) stats[p].dates[t.date] = { w:0, l:0, t:0 };
    if      (t.status === 'Win')  { stats[p].wins++;   stats[p].dates[t.date].w++; }
    else if (t.status === 'Loss') { stats[p].losses++;  stats[p].dates[t.date].l++; }
    else if (t.status === 'Tie')  { stats[p].ties++;    stats[p].dates[t.date].t++; }
  });
  // Compute win rate for each pair (settled = wins+losses only)
  Object.keys(stats).forEach(p => {
    const settled = stats[p].wins + stats[p].losses;
    stats[p].wr = settled > 0 ? (stats[p].wins / settled * 100) : 0;
    stats[p].settled = settled;
  });
  return stats;
}

function initPairsView() {
  const today  = new Date().toISOString().slice(0,10);
  const from30 = new Date(); from30.setDate(from30.getDate()-30);
  const pFrom  = document.getElementById('pFrom');
  const pTo    = document.getElementById('pTo');
  if (!pFrom.value) pFrom.value = from30.toISOString().slice(0,10);
  if (!pTo.value)   pTo.value   = today;
  updatePairsView();
}

function updatePairsView() {
  const from = document.getElementById('pFrom').value;
  const to   = document.getElementById('pTo').value;
  if (!from || !to) return;

  const allTrades = getAllTradesFromStorage(from, to);
  const pairStats = buildPairStats(allTrades);
  const pairs     = Object.keys(pairStats).sort();

  // Populate pair dropdown
  const pSel = document.getElementById('pairSelect');
  const prev = pSel.value;
  pSel.innerHTML = '<option value="all">All Currency Pairs</option>';
  pairs.forEach(p => {
    const o = document.createElement('option');
    o.value = p; o.textContent = p;
    pSel.appendChild(o);
  });
  if (pairs.includes(prev)) pSel.value = prev;

  // Populate date dropdown
  const dSel = document.getElementById('pairDateSelect');
  const prevD = dSel.value;
  // Collect all dates that have trades
  const allDates = [...new Set(allTrades.map(t => t.date))].sort().reverse();
  dSel.innerHTML = '<option value="all">All Dates</option>';
  allDates.forEach(d => {
    const o = document.createElement('option');
    o.value = d; o.textContent = fDate(d);
    dSel.appendChild(o);
  });
  if (allDates.includes(prevD)) dSel.value = prevD;

  const selectedPair = pSel.value;
  const selectedDate = dSel.value;

  // Filter trades further if a specific date is selected
  let filteredTrades = allTrades;
  if (selectedDate !== 'all') {
    filteredTrades = allTrades.filter(t => t.date === selectedDate);
  }
  const filteredStats = buildPairStats(filteredTrades);
  const filteredPairs = Object.keys(filteredStats).sort();

  if (!filteredPairs.length) {
    document.getElementById('bestPairBanner').style.display   = 'none';
    document.getElementById('pairDetailSection').style.display= 'none';
    document.getElementById('pairsGridContainer').innerHTML    =
      `<div class="pairs-empty"><div class="emo">💱</div><p>No currency pair data found.<br>Import trades with Asset information to see pair analysis.</p></div>`;
    return;
  }

  // Find best pair (highest win rate, min 1 settled trade)
  const bestPair = filteredPairs
    .filter(p => filteredStats[p].settled > 0)
    .sort((a,b) => filteredStats[b].wr - filteredStats[a].wr)[0] || filteredPairs[0];

  renderBestPairBanner(bestPair, filteredStats[bestPair]);
  renderPairsGrid(filteredPairs, filteredStats, bestPair, selectedPair);

  // Detail section for selected pair
  if (selectedPair !== 'all' && filteredStats[selectedPair]) {
    renderPairDetail(selectedPair, filteredStats[selectedPair], allTrades);
  } else if (selectedPair === 'all') {
    document.getElementById('pairDetailSection').style.display = 'none';
  }
}

function renderBestPairBanner(name, s) {
  const banner = document.getElementById('bestPairBanner');
  banner.style.display = 'block';
  document.getElementById('bestPairName').textContent = name;

  const statsData = [
    { val: s.total,            key: 'Total Trades', color: '#f0f0f8' },
    { val: s.wins,             key: 'Wins',         color: '#00e5a0' },
    { val: s.losses,           key: 'Losses',       color: '#ff4d6d' },
    { val: s.ties,             key: 'Ties',         color: '#f4a261' },
    { val: s.wr.toFixed(1)+'%',key: 'Win Rate',     color: '#00e5a0' },
    { val: s.settled,          key: 'Settled',      color: '#6c63ff' },
  ];

  document.getElementById('bestPairStats').innerHTML = statsData.map(d =>
    `<div class="bps-card">
      <div class="bps-val" style="color:${d.color}">${d.val}</div>
      <div class="bps-key">${d.key}</div>
    </div>`
  ).join('');
}

function renderPairsGrid(pairs, stats, bestPair, selectedPair) {
  const sorted = [...pairs].sort((a,b) => stats[b].wr - stats[a].wr);

  document.getElementById('pairsGridContainer').innerHTML =
    `<div class="pairs-grid">${sorted.map(p => {
      const s   = stats[p];
      const wr  = s.wr;
      const cls = wr >= 60 ? 'wr-high' : wr >= 40 ? 'wr-mid' : 'wr-low';
      const isBest = p === bestPair;
      const barColor = wr >= 60 ? 'var(--win)' : wr >= 40 ? 'var(--tie)' : 'var(--loss)';
      const isSelected = p === selectedPair;

      return `<div class="pair-card ${cls}${isBest?' best-card':''}" onclick="selectPair('${p.replace(/'/g,"\\'")}')">
        <div class="pc-head">
          <div class="pc-name">${p}</div>
          ${isBest ? '<span class="pc-badge pc-best">👑 Best</span>' : ''}
        </div>
        <div class="pc-stats">
          <div class="pc-stat"><div class="pc-stat-val" style="color:var(--win)">${s.wins}</div><div class="pc-stat-key">Wins</div></div>
          <div class="pc-stat"><div class="pc-stat-val" style="color:var(--loss)">${s.losses}</div><div class="pc-stat-key">Losses</div></div>
          <div class="pc-stat"><div class="pc-stat-val" style="color:var(--tie)">${s.ties}</div><div class="pc-stat-key">Ties</div></div>
        </div>
        <div class="pc-wr">Win Rate: <strong style="color:${barColor}">${wr.toFixed(1)}%</strong> &nbsp;·&nbsp; ${s.total} trades</div>
        <div class="pc-bar-wrap">
          <div class="pc-bar" style="width:${Math.min(wr,100)}%;background:${barColor}"></div>
        </div>
      </div>`;
    }).join('')}</div>`;
}

function selectPair(pairName) {
  const pSel = document.getElementById('pairSelect');
  pSel.value = pairName;
  updatePairsView();
  document.getElementById('pairDetailSection').scrollIntoView({ behavior:'smooth', block:'start' });
}

function renderPairDetail(pairName, s, allTrades) {
  const sec = document.getElementById('pairDetailSection');
  sec.style.display = 'block';
  document.getElementById('pdsTitle').textContent = '💱 ' + pairName + ' — Performance Detail';

  // Pie chart
  if (pairPieInst) { pairPieInst.destroy(); pairPieInst = null; }
  const pieCtx = document.getElementById('pairPieChart').getContext('2d');
  pairPieInst = new Chart(pieCtx, {
    type: 'doughnut',
    data: {
      labels: ['Wins','Losses','Ties'],
      datasets: [{
        data: [s.wins, s.losses, s.ties],
        backgroundColor: ['#00e5a0','#ff4d6d','#f4a261'],
        borderWidth: 0, hoverOffset: 4
      }]
    },
    options: {
      cutout: '65%', responsive: true,
      plugins: {
        legend: { display: true, position:'bottom',
          labels:{ color:'#6b6b8a', font:{ family:'DM Mono', size:10 }, padding:14 }
        },
        tooltip:{ callbacks:{ label: c => ` ${c.label}: ${c.parsed}` }}
      }
    }
  });

  // Trend chart (win rate by date)
  if (pairTrendInst) { pairTrendInst.destroy(); pairTrendInst = null; }
  const pairTrades = allTrades.filter(t => (t.asset||'').trim() === pairName);
  const dateMap    = {};
  pairTrades.forEach(t => {
    if (!dateMap[t.date]) dateMap[t.date] = { w:0, l:0 };
    if (t.status==='Win')  dateMap[t.date].w++;
    if (t.status==='Loss') dateMap[t.date].l++;
  });
  const tDates = Object.keys(dateMap).sort();
  const tWR    = tDates.map(d => {
    const s2 = dateMap[d].w + dateMap[d].l;
    return s2 > 0 ? (dateMap[d].w / s2 * 100).toFixed(1) : null;
  });

  const trendCtx = document.getElementById('pairTrendChart').getContext('2d');
  const bf = { family:'DM Mono', size:10 };
  const gc = 'rgba(255,255,255,0.05)';
  pairTrendInst = new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: tDates.map(d => d.slice(5)),
      datasets: [{
        label:'Win Rate %', data: tWR,
        borderColor:'#00e5a0', backgroundColor:'rgba(0,229,160,.1)',
        fill:true, tension:.4, pointRadius:4,
        pointBackgroundColor:'#00e5a0', borderWidth:2,
        spanGaps:true
      }]
    },
    options: {
      responsive:true, animation:{ duration:400 },
      scales:{
        x:{ ticks:{ font:bf, color:'#6b6b8a' }, grid:{ color:gc } },
        y:{ min:0, max:100, ticks:{ font:bf, color:'#6b6b8a' }, grid:{ color:gc } }
      },
      plugins:{
        legend:{ display:false },
        tooltip:{ callbacks:{ label: c => ` Win Rate: ${c.parsed.y}%` }}
      }
    }
  });
}

// ──────────────────────────────
// STORAGE MANAGER
// ──────────────────────────────
function getStorageEntries() {
  const entries = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    const val = localStorage.getItem(key);
    let type    = 'other';
    let date    = '';
    let display = key;
    let count   = '—';
    let acctTag = '';
    const sizeBytes = new Blob([val]).size;

    if (key.startsWith('demo_trades_')) {
      type = 'trades'; acctTag = ' 🔵 Demo';
      date = key.slice('demo_trades_'.length);
      display = fmtDateDMY(date) + acctTag;
      try { const arr = JSON.parse(val); count = arr.length + ' trade' + (arr.length !== 1 ? 's' : ''); } catch(e) { count = '?'; }
    } else if (key.startsWith('trades_')) {
      type = 'trades'; acctTag = ' 🟢 Live';
      date = key.slice('trades_'.length);
      display = fmtDateDMY(date) + acctTag;
      try { const arr = JSON.parse(val); count = arr.length + ' trade' + (arr.length !== 1 ? 's' : ''); } catch(e) { count = '?'; }
    } else if (key.startsWith('demo_goal_')) {
      type = 'goal'; date = key.slice('demo_goal_'.length);
      display = fmtDateDMY(date) + ' — Win Rate Goal 🔵';
      count = val + '%';
    } else if (key.startsWith('goal_')) {
      type = 'goal'; date = key.slice('goal_'.length);
      display = fmtDateDMY(date) + ' — Win Rate Goal 🟢';
      count = val + '%';
    } else if (key.startsWith('demo_winsgoal_')) {
      type = 'goal'; date = key.slice('demo_winsgoal_'.length);
      display = fmtDateDMY(date) + ' — Wins Goal 🔵';
      count = val + ' wins';
    } else if (key.startsWith('winsgoal_')) {
      type = 'goal'; date = key.slice('winsgoal_'.length);
      display = fmtDateDMY(date) + ' — Wins Goal 🟢';
      count = val + ' wins';
    } else if (key === 'pb_winrate') {
      type = 'pb'; display = 'All-time Personal Best'; date = '';
      count = parseFloat(val).toFixed(2) + '%';
    } else if (key === 'demo_balance') {
      type = 'other'; display = 'Demo Account Balance';
      count = '$' + parseFloat(val).toFixed(2);
    } else if (key === 'main_balance') {
      type = 'other'; display = 'Live Account Balance';
      count = '$' + parseFloat(val).toFixed(2);
    }

    entries.push({ key, type, date, display, count, sizeBytes, val });
  }

  // Sort: trades by date desc, then goals, then other
  const order = { trades: 0, goal: 1, pb: 2, other: 3 };
  entries.sort((a, b) => {
    if (order[a.type] !== order[b.type]) return order[a.type] - order[b.type];
    if (a.date && b.date) return b.date.localeCompare(a.date);
    return 0;
  });
  return entries;
}

function fmtBytes(n) {
  if (n < 1024) return n + ' B';
  return (n / 1024).toFixed(1) + ' KB';
}

function renderStorageTable() {
  const entries = getStorageEntries();

  // Overview cards
  const tradeEntries = entries.filter(e => e.type === 'trades');
  const totalTrades  = tradeEntries.reduce((sum, e) => {
    try { return sum + JSON.parse(e.val).length; } catch(_) { return sum; }
  }, 0);
  const totalBytes   = entries.reduce((s, e) => s + e.sizeBytes, 0);
  const pb           = localStorage.getItem('pb_winrate');

  document.getElementById('storageOverview').innerHTML = `
    <div class="sov-card"><div class="sov-val" style="color:var(--accent)">${tradeEntries.length}</div><div class="sov-key">Trading Days</div></div>
    <div class="sov-card"><div class="sov-val" style="color:var(--accent3)">${totalTrades}</div><div class="sov-key">Total Trades</div></div>
    <div class="sov-card"><div class="sov-val" style="color:var(--tie)">${pb ? parseFloat(pb).toFixed(1)+'%' : '—'}</div><div class="sov-key">Personal Best</div></div>
    <div class="sov-card"><div class="sov-val" style="color:var(--muted);font-size:1.2rem">${fmtBytes(totalBytes)}</div><div class="sov-key">Total Size</div></div>`;

  const container = document.getElementById('storageTableContainer');

  if (!entries.length) {
    container.innerHTML = `<div class="storage-empty"><div class="emo">📭</div><p>No data stored yet.<br>Add trades on the Trades tab to get started.</p></div>`;
    return;
  }

  const rows = entries.map(e => {
    let chipClass = 'st-trades';
    let chipLabel = 'Trades';
    if (e.type === 'goal')  { chipClass = 'st-goal'; chipLabel = 'Goal'; }
    if (e.type === 'pb')    { chipClass = 'st-pb';   chipLabel = 'Personal Best'; }
    if (e.type === 'other') { chipClass = 'st-goal'; chipLabel = 'Other'; }

    const canPreview = e.type === 'trades';

    return `<tr>
      <td><span class="st-type-chip ${chipClass}">${chipLabel}</span></td>
      <td class="st-date">${e.display}</td>
      <td class="st-key">${e.key}</td>
      <td class="st-count">${e.count}</td>
      <td class="st-size">${fmtBytes(e.sizeBytes)}</td>
      <td style="text-align:right;display:flex;gap:6px;justify-content:flex-end;align-items:center">
        ${canPreview ? `<button class="del-row-btn" style="color:var(--accent3);border-color:rgba(108,99,255,.2)" onclick="loadDateFromStorage('${e.date}')">📂 View</button>` : ''}
        <button class="del-row-btn" onclick="deleteStorageKey('${e.key}')">🗑 Delete</button>
      </td>
    </tr>`;
  }).join('');

  container.innerHTML = `
    <div class="storage-table-wrap">
      <table>
        <thead><tr>
          <th>Type</th>
          <th>Date / Description</th>
          <th>Storage Key</th>
          <th>Content</th>
          <th>Size</th>
          <th style="text-align:right">Actions</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
}

function deleteStorageKey(key) {
  const isCurrentDate = key === tradesKey(currentDate) ||
                        key === goalKey(currentDate)   ||
                        key === winsGoalKey(currentDate);

  showModal(
    'Delete Entry?',
    `Remove "${key}" from localStorage? This cannot be undone.`,
    'Delete',
    () => {
      localStorage.removeItem(key);
      // If deleting current date's data, reload trades tab
      if (isCurrentDate) loadDateData();
      renderStorageTable();
      toast('Entry deleted', 'ok');
    }
  );
}

function clearAllStorage() {
  showModal(
    'Delete ALL Data?',
    'This will permanently erase ALL trades, goals, personal best, and balance from your browser. This cannot be undone.',
    'Delete Everything',
    () => {
      const wasHidden = localStorage.getItem('balance_hidden');
      localStorage.clear();
      // Restore balance visibility state only (not balance value)
      if (wasHidden) localStorage.setItem('balance_hidden', wasHidden);
      trades = []; goal1 = null; goal2 = null; winsGoalFired = false;
      loadDateData();
      renderBalanceDisplay();
      renderStorageTable();
      toast('All data cleared', 'ok');
    }
  );
}

function loadDateFromStorage(date) {
  // Switch to Trades tab and load that date
  document.getElementById('dateSelector').value = date;
  switchTab('trades');
  loadDateData();
  toast('Loaded ' + fmtDateDMY(date), 'ok');
}

// ──────────────────────────────
// BACKUP & RESTORE
// ──────────────────────────────
function backupData() {
  const backup = { version: 1, exportedAt: new Date().toISOString(), data: {} };
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    backup.data[key] = localStorage.getItem(key);
  }
  if (!Object.keys(backup.data).length) {
    toast('No data to backup', 'err'); return;
  }
  const json = JSON.stringify(backup, null, 2);
  const a    = document.createElement('a');
  a.href     = URL.createObjectURL(new Blob([json], { type: 'application/json' }));
  a.download = 'TradeEdge_Backup_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  document.getElementById('backupMeta').textContent =
    'Last backup: ' + new Date().toLocaleString() + ' — ' + Object.keys(backup.data).length + ' entries';
  toast('✓ Backup downloaded!', 'ok');
}

function restoreData(input) {
  const file = input.files[0];
  if (!file) return;
  if (!file.name.toLowerCase().endsWith('.json')) {
    toast('Please select a .json backup file', 'err'); return;
  }
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const backup = JSON.parse(e.target.result);
      if (!backup.data || typeof backup.data !== 'object') throw new Error('Invalid backup format');

      const keys = Object.keys(backup.data);
      showModal(
        'Restore Backup?',
        `This will merge ${keys.length} entries from the backup (exported ${backup.exportedAt ? new Date(backup.exportedAt).toLocaleDateString() : 'unknown date'}). Existing data for matching dates will be overwritten.`,
        'Restore',
        () => {
          keys.forEach(k => localStorage.setItem(k, backup.data[k]));
          loadDateData();
          renderStorageTable();
          document.getElementById('backupMeta').textContent =
            'Restored: ' + keys.length + ' entries from backup at ' + new Date().toLocaleString();
          toast('✓ Backup restored successfully! ' + keys.length + ' entries loaded.', 'ok');
        }
      );
    } catch(err) {
      toast('Failed to parse backup: ' + err.message, 'err');
    }
    input.value = ''; // reset so same file can be picked again
  };
  reader.readAsText(file);
}

// ──────────────────────────────
// MAIN BALANCE (account-aware)
// ──────────────────────────────
function getBalanceKey()   { return activeAccount === 'demo' ? 'demo_balance'   : 'main_balance'; }

// All data keys use a prefix so Live and Demo are fully isolated
function acctPrefix()     { return activeAccount === 'demo' ? 'demo_'          : ''; }
function tradesKey(date)  { return acctPrefix() + 'trades_'   + date; }
function goalKey(date)    { return acctPrefix() + 'goal_'     + date; }
function winsGoalKey(date){ return acctPrefix() + 'winsgoal_' + date; }
function pgoalKey(id)     { return acctPrefix() + id; }           // period-goal prefix
function tradesPrefix()   { return acctPrefix() + 'trades_'; }    // for key scanning

function loadBalance() {
  const hidden = localStorage.getItem('balance_hidden') === 'true';
  balanceHidden = hidden;
  renderBalanceDisplay();
  if (hidden) {
    document.getElementById('balanceWrap').classList.add('balance-blurred');
    document.getElementById('balanceHideBtn').textContent = '🙈';
  }
}

function editBalance() {
  if (balanceHidden) return;
  const val = parseFloat(localStorage.getItem(getBalanceKey()) || '0');
  document.getElementById('balanceInput').value = val.toFixed(2);
  document.getElementById('balanceDisplay').classList.add('hidden-when-editing');
  document.getElementById('balanceInputWrap').classList.add('active');
  document.getElementById('balanceInput').focus();
  document.getElementById('balanceInput').select();
}

function saveBalance() {
  const raw = parseFloat(document.getElementById('balanceInput').value);
  const val = isNaN(raw) ? 0 : raw;
  localStorage.setItem(getBalanceKey(), val.toFixed(2));
  document.getElementById('balanceDisplay').classList.remove('hidden-when-editing');
  document.getElementById('balanceInputWrap').classList.remove('active');
  renderBalanceDisplay();
  toast('Balance saved: $' + Math.abs(val).toFixed(2), 'ok');
}

function autoSaveBalance() {
  clearTimeout(_balanceSaveTimer);
  _balanceSaveTimer = setTimeout(() => {
    const raw = parseFloat(document.getElementById('balanceInput').value);
    if (!isNaN(raw)) {
      localStorage.setItem(getBalanceKey(), raw.toFixed(2));
      renderBalanceDisplay();
    }
  }, 400);
}

function balanceKeydown(e) {
  if (e.key === 'Enter') saveBalance();
  if (e.key === 'Escape') {
    document.getElementById('balanceDisplay').classList.remove('hidden-when-editing');
    document.getElementById('balanceInputWrap').classList.remove('active');
  }
}

function toggleBalanceVisibility() {
  balanceHidden = !balanceHidden;
  localStorage.setItem('balance_hidden', balanceHidden);
  const wrap = document.getElementById('balanceWrap');
  const btn  = document.getElementById('balanceHideBtn');
  if (balanceHidden) {
    wrap.classList.add('balance-blurred');
    btn.textContent = '🙈';
    document.getElementById('balanceDisplay').classList.remove('hidden-when-editing');
    document.getElementById('balanceInputWrap').classList.remove('active');
  } else {
    wrap.classList.remove('balance-blurred');
    btn.textContent = '👁';
  }
}

// ──────────────────────────────
// WEEKLY / MONTHLY GOALS
// ──────────────────────────────
function switchPeriodGoal(period) {
  activePeriodGoal = period;
  document.getElementById('ptWeek').classList.toggle('active', period === 'week');
  document.getElementById('ptMonth').classList.toggle('active', period === 'month');
  renderPeriodGoals();
}

function getISOWeekKey() {
  // Returns "YYYY-Www" key for current week
  const d = new Date(currentDate + 'T12:00:00');
  const day = d.getDay() || 7;
  d.setDate(d.getDate() + 4 - day);
  const year = d.getFullYear();
  const jan1 = new Date(year, 0, 1);
  const week = Math.ceil(((d - jan1) / 86400000 + 1) / 7);
  return year + '-W' + String(week).padStart(2, '0');
}

function getMonthKey() {
  if (!currentDate) return '';
  return currentDate.slice(0, 7); // "YYYY-MM"
}

function getPeriodKey(period) {
  return period === 'week' ? getISOWeekKey() : getMonthKey();
}

function getAllTradesForPeriod(period) {
  // Get all trades in current week or month
  const all = [];
  const dStr = currentDate || new Date().toISOString().slice(0,10);
  let start, end;

  if (period === 'week') {
    const d = new Date(dStr + 'T12:00:00');
    const day = d.getDay() || 7;
    start = new Date(d); start.setDate(d.getDate() - day + 1);
    end   = new Date(d); end.setDate(d.getDate() + (7 - day));
  } else {
    const [y, m] = dStr.split('-');
    start = new Date(parseInt(y), parseInt(m)-1, 1);
    end   = new Date(parseInt(y), parseInt(m), 0);
  }

  const cur = new Date(start);
  while (cur <= end) {
    const ds  = cur.toISOString().slice(0,10);
    const raw = localStorage.getItem(tradesKey(ds));
    if (raw) JSON.parse(raw).forEach(t => all.push(t));
    cur.setDate(cur.getDate() + 1);
  }
  return all;
}

function renderPeriodGoals() {
  const period  = activePeriodGoal;
  const pKey    = getPeriodKey(period);
  const allT    = getAllTradesForPeriod(period);
  const wins    = allT.filter(t => t.status === 'Win').length;
  const losses  = allT.filter(t => t.status === 'Loss').length;
  const settled = wins + losses;
  const wr      = settled > 0 ? (wins / settled * 100) : 0;
  let pnl = 0;
  allT.forEach(t => { const v = parseFloat(t.pnl); if (!isNaN(v)) pnl += v; });

  // Load saved goals for this period
  const g1key  = pgoalKey(`pgoal_wr_${pKey}`);
  const g2key  = pgoalKey(`pgoal_wins_${pKey}`);
  const g3key  = pgoalKey(`pgoal_pnl_${pKey}`);
  const tgtWR  = parseFloat(localStorage.getItem(g1key)  || '0');
  const tgtW   = parseInt(localStorage.getItem(g2key)   || '0');
  const tgtPnl = parseFloat(localStorage.getItem(g3key) || '0');

  const labelPeriod = period === 'week' ? 'Week' : 'Month';

  function goalRow(id, label, current, target, unit, format) {
    const pct = target > 0 ? Math.min((current / target) * 100, 100) : 0;
    const achieved = target > 0 && current >= target;
    const exceeded = target > 0 && current > target * 1.1;
    const badge = exceeded
      ? '<span class="pgi-badge exceeded">🚀 Exceeded</span>'
      : achieved ? '<span class="pgi-badge achieved">✅ Hit</span>' : '';
    return `<div class="period-goal-item">
      <div class="pgi-label">${label}</div>
      <input type="number" class="pgi-inp" id="${id}_inp" value="${target||''}" placeholder="Target" step="${unit==='%'?'1':'0.01'}">
      <button class="pgi-set" onclick="setPeriodGoal('${id}','${pKey}')">SET</button>
      <div class="pgi-prog-wrap"><div class="pgi-prog-bar" style="width:${pct}%"></div></div>
      <div class="pgi-val">${format(current)}${target>0?' / '+format(target):''}${badge}</div>
    </div>`;
  }

  document.getElementById('periodGoalItems').innerHTML = `
    <div style="font-size:.68rem;color:var(--muted);margin-bottom:10px">
      ${labelPeriod}: ${pKey} &nbsp;·&nbsp; ${allT.length} trades &nbsp;·&nbsp; ${wins}W/${losses}L
    </div>
    ${goalRow('pgoal_wr_'+pKey,  'Win Rate', wr,   tgtWR,  '%',  v => v.toFixed(1)+'%')}
    ${goalRow('pgoal_wins_'+pKey,'Tot Wins', wins, tgtW,   'n',  v => v)}
    ${goalRow('pgoal_pnl_'+pKey, 'P&L',     pnl,  tgtPnl, '$',  v => (v>=0?'+':'') + '$'+Math.abs(v).toFixed(2))}
  `;
}

function setPeriodGoal(id, pKey) {
  const inp = document.getElementById(id + '_inp');
  if (!inp) return;
  const v = parseFloat(inp.value);
  if (isNaN(v)) { toast('Enter a valid number', 'err'); return; }
  localStorage.setItem(pgoalKey(id), v.toFixed(4));
  renderPeriodGoals();
  toast('Goal saved!', 'ok');
}

// ──────────────────────────────
// MONTHLY SUMMARY REPORT
// ──────────────────────────────
function populateSummaryYears() {
  const sel = document.getElementById('summaryYearSel');
  if (!sel) return;
  const years = new Set();
  const today = new Date();
  years.add(today.getFullYear());
  years.add(today.getFullYear() - 1);
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    if (k && k.startsWith(tradesPrefix())) {
      const yr = k.slice(tradesPrefix().length, tradesPrefix().length + 4);
      if (yr && !isNaN(yr)) years.add(parseInt(yr));
    }
  }
  const sorted = [...years].sort((a, b) => b - a);
  const curVal = sel.value || String(today.getFullYear());
  sel.innerHTML = sorted.map(y => `<option value="${y}" ${String(y)===curVal?'selected':''}>${y}</option>`).join('');
}

function populateSummaryMonths() {
  const sel = document.getElementById('summaryMonthSel');
  if (!sel) return;
  const months = [
    'January','February','March','April','May','June',
    'July','August','September','October','November','December'
  ];
  const today = new Date();
  const curMonth = String(today.getMonth() + 1).padStart(2,'0');
  const curVal = sel.value || curMonth;
  sel.innerHTML = months.map((name, i) => {
    const val = String(i+1).padStart(2,'0');
    return `<option value="${val}" ${val===curVal?'selected':''}>${name}</option>`;
  }).join('');
}

function renderMonthlySummary() {
  const yearSel  = document.getElementById('summaryYearSel');
  const monthSel = document.getElementById('summaryMonthSel');
  if (!yearSel || !monthSel) return;

  const year  = yearSel.value;
  const month = monthSel.value;
  if (!year || !month) return;

  const prefix    = year + '-' + month;
  const daysInMo  = new Date(parseInt(year), parseInt(month), 0).getDate();
  const container = document.getElementById('summaryReportContainer');

  // Collect all data for this month
  const allTrades   = [];
  const dayStats    = {};

  for (let d = 1; d <= daysInMo; d++) {
    const ds  = prefix + '-' + String(d).padStart(2,'0');
    const raw = localStorage.getItem(tradesKey(ds));
    if (!raw) continue;
    const ts  = JSON.parse(raw);
    if (!ts.length) continue;

    const w  = ts.filter(t => t.status === 'Win').length;
    const l  = ts.filter(t => t.status === 'Loss').length;
    const s  = w + l;
    let pnl  = 0; ts.forEach(t => { const v = parseFloat(t.pnl); if (!isNaN(v)) pnl += v; });

    ts.forEach(t => allTrades.push({ ...t, date: ds }));
    dayStats[ds] = { wins: w, losses: l, settled: s, total: ts.length, wr: s > 0 ? w/s*100 : 0, pnl };
  }

  const dayKeys    = Object.keys(dayStats).sort();
  const monthName  = new Date(parseInt(year), parseInt(month)-1, 1)
                      .toLocaleString('en-US', { month: 'long' });

  if (!dayKeys.length) {
    container.innerHTML = `<div class="sum-empty"><div class="emo">📭</div>
      <p>No trades found for ${monthName} ${year}.<br>Import or add trades first.</p></div>`;
    return;
  }

  // Aggregate stats
  const totTrades = dayKeys.reduce((a,d) => a + dayStats[d].total, 0);
  const totWins   = dayKeys.reduce((a,d) => a + dayStats[d].wins, 0);
  const totLosses = dayKeys.reduce((a,d) => a + dayStats[d].losses, 0);
  const totSettled= dayKeys.reduce((a,d) => a + dayStats[d].settled, 0);
  const totPnl    = dayKeys.reduce((a,d) => a + dayStats[d].pnl, 0);
  const overallWR = totSettled > 0 ? (totWins / totSettled * 100) : 0;

  // Best & worst day (by win rate, with ≥1 settled trade)
  const bestDay   = dayKeys.reduce((a,b) => dayStats[a].wr >= dayStats[b].wr ? a : b);
  const worstDay  = dayKeys.reduce((a,b) => dayStats[a].wr <= dayStats[b].wr ? a : b);

  // Most active day
  const mostActive = dayKeys.reduce((a,b) => dayStats[a].total >= dayStats[b].total ? a : b);

  // Best currency pair
  const pStats = buildPairStats(allTrades);
  const pSorted = Object.keys(pStats).sort((a,b) => pStats[b].wr - pStats[a].wr);
  const bestPair  = pSorted[0] || null;
  const worstPair = pSorted[pSorted.length-1] || null;

  const pnlSign = totPnl >= 0 ? '+' : '';
  const pnlColor = totPnl >= 0 ? 'var(--win)' : 'var(--loss)';

  // KPI cards
  const kpiCards = [
    { val: totTrades,          key: 'Total Trades',  color: 'var(--accent3)' },
    { val: overallWR.toFixed(1)+'%', key: 'Win Rate',color: overallWR>=60?'var(--win)':overallWR>=40?'var(--tie)':'var(--loss)' },
    { val: pnlSign + '$' + Math.abs(totPnl).toFixed(2), key: 'Total P&L', color: pnlColor },
    { val: dayKeys.length,     key: 'Active Days',   color: 'var(--muted)' },
    { val: totWins,            key: 'Total Wins',    color: 'var(--win)' },
    { val: totLosses,          key: 'Total Losses',  color: 'var(--loss)' },
  ].map(c => `<div class="sum-kpi">
    <div class="sum-kpi-val" style="color:${c.color}">${c.val}</div>
    <div class="sum-kpi-key">${c.key}</div>
  </div>`).join('');

  // Day-by-day table
  const dayRows = dayKeys.map(ds => {
    const s   = dayStats[ds];
    const isBest  = ds === bestDay;
    const isWorst = ds === worstDay;
    const d = new Date(ds + 'T12:00:00');
    const label = d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });
    const pnlTxt = (s.pnl >= 0 ? '+' : '') + '$' + Math.abs(s.pnl).toFixed(2);
    const pnlCls = s.pnl >= 0 ? 'pnl-pos' : 'pnl-neg';
    const wrTxt  = s.settled > 0 ? s.wr.toFixed(1)+'%' : '—';
    const wrCls  = s.wr >= 60 ? 'sum-highlight-best' : s.wr < 40 && s.settled>0 ? 'sum-highlight-worst' : '';
    return `<tr>
      <td>${label}${isBest ? '<span class="sum-badge-best">BEST</span>' : ''}${isWorst && ds!==bestDay ? '<span class="sum-badge-worst">WORST</span>' : ''}</td>
      <td>${s.total}</td>
      <td class="sum-highlight-best">${s.wins}</td>
      <td class="sum-highlight-worst">${s.losses}</td>
      <td class="${wrCls}">${wrTxt}</td>
      <td class="${pnlCls}">${s.pnl !== 0 ? pnlTxt : '—'}</td>
    </tr>`;
  }).join('');

  // Best pair section
  const bestPairInfo = bestPair ? `
    <div class="sum-section">
      <div class="sum-section-title">💱 Currency Pair Performance</div>
      <table class="sum-pair-table">
        <thead><tr><th>Pair</th><th>Trades</th><th>Wins</th><th>Losses</th><th>Ties</th><th>Win Rate</th><th>P&amp;L</th></tr></thead>
        <tbody>${pSorted.slice(0,10).map(p => {
          const ps = pStats[p];
          const wrC = ps.wr>=60?'sum-highlight-best':ps.wr<40?'sum-highlight-worst':'';
          let ppnl = 0;
          allTrades.filter(t => t.asset === p).forEach(t => { const v = parseFloat(t.pnl); if (!isNaN(v)) ppnl += v; });
          const ppnlTxt = (ppnl >= 0 ? '+' : '') + '$' + Math.abs(ppnl).toFixed(2);
          const isBestP = p === bestPair;
          const isWorstP = p === worstPair && p !== bestPair;
          return `<tr>
            <td><strong>${p}</strong>${isBestP ? '<span class="sum-badge-best">BEST</span>' : ''}${isWorstP ? '<span class="sum-badge-worst">WORST</span>' : ''}</td>
            <td>${ps.total}</td>
            <td style="color:var(--win)">${ps.wins}</td>
            <td style="color:var(--loss)">${ps.losses}</td>
            <td style="color:var(--tie)">${ps.ties}</td>
            <td class="${wrC}">${ps.wr.toFixed(1)}%</td>
            <td class="${ppnl>=0?'pnl-pos':'pnl-neg'}">${ppnlTxt}</td>
          </tr>`;
        }).join('')}</tbody>
      </table>
    </div>` : '';

  container.innerHTML = `
    <div class="sum-section">
      <div class="sum-section-title">📊 ${monthName} ${year} — Overview</div>
      <div class="sum-kpi-grid">${kpiCards}</div>
    </div>
    ${bestPairInfo}
    <div class="sum-section">
      <div class="sum-section-title">📅 Day-by-Day Breakdown</div>
      <table class="sum-day-table">
        <thead><tr><th>Date</th><th>Trades</th><th>Wins</th><th>Losses</th><th>Win Rate</th><th>P&amp;L</th></tr></thead>
        <tbody>${dayRows}</tbody>
      </table>
    </div>
  `;
}

// ──────────────────────────────
// TOAST
// ──────────────────────────────
function toast(msg, type) {
  const stack = document.getElementById('toastStack');
  const el    = document.createElement('div');
  el.className = 'toast ' + (type === 'ok' ? 'ok' : 'err');
  el.textContent = (type === 'ok' ? '✓ ' : '✕ ') + msg;
  stack.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}
</script>
</body>
</html>
